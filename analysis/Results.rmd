---
title: "Results"
author: "Colin Crooks"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_caption: true
---




```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)

###########################################################
#https://github.com/ateucher/useful_code/blob/master/R/numbers2words.r
#https://gist.github.com/psychemedia/numbers2words.R
numbers2words <- function(x){
  ## Function by John Fox found here: 
  ## http://tolstoy.newcastle.edu.au/R/help/05/04/2715.html
  ## Tweaks by AJH to add commas and "and"
  helper <- function(x){
    
    digits <- rev(strsplit(as.character(x), "")[[1]])
    nDigits <- length(digits)
    if (nDigits == 1) as.vector(ones[digits])
    else if (nDigits == 2)
      if (x <= 19) as.vector(teens[digits[1]])
    else trim(paste(tens[digits[2]],
                    Recall(as.numeric(digits[1]))))
    else if (nDigits == 3) trim(paste(ones[digits[3]], "hundred and", 
                                      Recall(makeNumber(digits[2:1]))))
    else {
      nSuffix <- ((nDigits + 2) %/% 3) - 1
      if (nSuffix > length(suffixes)) stop(paste(x, "is too large!"))
      trim(paste(Recall(makeNumber(digits[
        nDigits:(3*nSuffix + 1)])),
        suffixes[nSuffix],"," ,
        Recall(makeNumber(digits[(3*nSuffix):1]))))
    }
  }
  trim <- function(text){
    #Tidy leading/trailing whitespace, space before comma
    text=gsub("^\ ", "", gsub("\ *$", "", gsub("\ ,",",",text)))
    #Clear any trailing " and"
    text=gsub(" and$","",text)
    #Clear any trailing comma
    gsub("\ *,$","",text)
  }  
  makeNumber <- function(...) as.numeric(paste(..., collapse=""))     
  #Disable scientific notation
  opts <- options(scipen=100) 
  on.exit(options(opts)) 
  ones <- c("", "one", "two", "three", "four", "five", "six", "seven",
            "eight", "nine") 
  names(ones) <- 0:9 
  teens <- c("ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen",
             "sixteen", " seventeen", "eighteen", "nineteen")
  names(teens) <- 0:9 
  tens <- c("twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty",
            "ninety") 
  names(tens) <- 2:9 
  x <- round(x)
  suffixes <- c("thousand", "million", "billion", "trillion")     
  if (length(x) > 1) return(trim(sapply(x, helper)))
  helper(x)
}

rnd <- function(x) round(x/5)*5

##########################################################


#########################
# Basic counts and descriptions from raw data
#############################
index_date <- data.table::as.IDate("2020-02-01")
dt <- data.table::fread(here::here("output", "input.csv"))

procedures <- c('Abdominal','Cardiac','Obstetrics','Orthopaedic','Thoracic', 'Vascular')
procs <- paste0(rep(procedures,each = 5),"_",1:5)

dt[,dateofbirth := (data.table::as.IDate(paste0(dob,'-15')))]
dt[dereg_date != "",gp.end := data.table::as.IDate(paste0(dereg_date,'-15'))]
dt[, imd := as.numeric(imd)]
dt[, imd5 := cut(imd, breaks = seq(0,33000,33000/5),  include.lowest = T, ordered_result = F)]

####################################################################
# Multiple operations per row. Reshape to long format
####################################################################

repeated.vars <- names(dt)[grepl(pattern = paste(procedures,collapse = '|'),x = names(dt))]
non.op.vars <- names(dt)[!grepl(pattern = paste(procedures,collapse = '|'),x = names(dt))]

aggregate_operations <- data.table::melt(dt, id.var = 'patient_id',
                                         measure = patterns(as.vector(outer(paste0(procedures,'_[0-9]'),
                                                                            unique(gsub(pattern = paste0(as.vector(outer(procedures,paste0("_",1:5),paste0)),collapse = "|"),replacement = "",x = repeated.vars)),
                                                                            paste0))),
                                         value.name = as.vector(outer(procedures,unique(gsub(pattern = paste0(as.vector(outer(procedures,paste0("_",1:5),paste0)),collapse = "|"),replacement = "",x = repeated.vars)),paste0)))
dt <- dt[,non.op.vars, with = F][aggregate_operations, on = "patient_id"]
rm(aggregate_operations)
dt[, keep := F]
dt[!is.na(dereg_date), dereg_date := data.table::as.IDate(paste0(dereg_date,"-30"), format = "%Y-%m-%d")]
for (x in paste0(procedures,"_date_admitted")) { dt[is.na(dereg_date) | x <= dereg_date, keep := T] }
dt <- dt[keep == T,]

n.ops <- rnd(sum(unlist(lapply(paste0(procedures,"_date_admitted"), function(x) dt[is.finite(get(x)),.N]))))
n.pats <- rnd(sum(length(unique(dt[,patient_id]))))
start.date <- data.table::as.IDate(min(vapply(paste0(procedures,"_date_admitted"), 
                                              FUN.VALUE = 1.0,
                                              FUN =function(x) unlist(dt[order(x),x, with = F][1]))))
last.date <- data.table::as.IDate(max(vapply(paste0(procedures,"_date_admitted"), 
                                             FUN.VALUE = 1.0, 
                                             FUN =function(x) unlist(dt[order(-x),x, with = F][1]))))

dt[,(paste("admit.wave.",procedures, sep ="")) := lapply(.SD, function(x) cut(as.numeric(x), breaks =
                                                                                c(as.numeric(data.table::as.IDate("2020-01-01", format = "%Y-%m-%d")), 
                                                                                  as.numeric(data.table::as.IDate("2020-09-01", format = "%Y-%m-%d")),                                       
                                                                                  as.numeric(data.table::as.IDate("2021-05-01", format = "%Y-%m-%d")),
                                                                                  as.numeric(data.table::as.IDate("2021-12-31", format = "%Y-%m-%d")),
                                                                                  as.numeric(data.table::as.IDate("2022-05-01", format = "%Y-%m-%d"))),
                                                                              labels = c("Wave_1","Wave_2","Wave_3","Wave_4"),
                                                                              ordered = T)), 
   .SDcols = c(paste0(procedures,"_date_admitted"))]
for(x in procedures) {
  dt[, (paste0(x,"post.VTE")) := ((!is.na(.SD[,3]) &  
                                     .SD[,3] <= .SD[,1] + 90 & .SD[,3] >= .SD[,1]) | 
                                    ((!is.na(.SD[,4]) &  
                                        .SD[,4] <= .SD[,1] + 90 & .SD[,4] >= .SD[,1]))) & 
       (!is.na(.SD[,5]) &  
          .SD[,5] <= .SD[,1] + 90 & .SD[,5] >= .SD[,1]), 
     .SDcols = paste0(procedures,c("_date_admitted","_date_discharged","_VTE_GP_date","_VTE_HES_date_admitted","_anticoagulation_prescriptions_date"))]  # events flagged at end of episode
}

```

## Study population
`r stringr::str_to_sentence(numbers2words(n.pats))` adult patients were identified undergoing at least one procedure whilst registered to a general practitioner using the SystmOne database at the time of the first procedure between `r format(start.date, format="%B %d %Y")` and `r format(last.date, format="%B %d %Y")`. `r stringr::str_to_sentence(numbers2words(n.ops))` procedures were identified within thse patients' registration period after restricting to the first 5 procedures within each category (abdominal, cardiac, obstetric, orthopaedic,  thoracic, & Vascular). The numbers and demographics of these patients and procedures are shown in Table 1.

```{r demo, results='asis', echo = T}

median.iqr <- function(x, dig=0) paste0(round(median(x, na.rm = T))," (",paste(round(quantile(x,c(0.25,0.75),na.rm = T),digits = dig),collapse = ","),")")

n.perc <- function(x, dig=0) paste0(rnd(sum(x == T, na.rm = T))," (",round(mean(x,na.rm = T),digits = dig)*100,"%)")

date.90.day <- function(x,ref.dat) is.finite(get(x)) & as.numeric(get(x)) - as.numeric(get(ref.dat)) <= 90  & as.numeric(get(x)) - as.numeric(get(ref.dat)) >=0

demo.tab <- xtable::xtable(
  data.table::rbindlist(
    list(lapply(procedures, function(proc) { 
  t(cbind(dt[is.finite(get(paste0(proc,'_date_admitted'))) ,.("Procedures" = rnd(.N),
                                 "Patients" = rnd(length(unique(patient_id))),
                                 "Female" = n.perc(sex=='F',dig = 3),
                                 "Age (IQR)" = median.iqr(as.numeric(get(paste0(proc,'_date_admitted')) - as.numeric(dateofbirth))/365.25,dig = 0),
                                 "BMI (IQR)" =  median.iqr(bmi,dig = 0),
                                 "IMD quintile (IQR)" = median.iqr(as.numeric(imd5),dig = 0),
                                 "1st Vaccination" = n.perc(is.finite(covid_vaccine_dates_1) & get(paste0(proc,'_date_admitted'))  - covid_vaccine_dates_1 >= 14,dig = 3),
                                 "2nd Vaccination" = n.perc(is.finite(covid_vaccine_dates_2) & get(paste0(proc,'_date_admitted'))  - covid_vaccine_dates_2 >= 14,dig = 3),
                                 "3rd Vaccination" = n.perc(is.finite(covid_vaccine_dates_3) & get(paste0(proc,'_date_admitted'))  - covid_vaccine_dates_3 >= 14,dig = 3),
                                 "Current Cancer"  = n.perc(substr(get(paste0(proc,'_primary_diagnosis')),1,1) =='C',dig = 3),
                                 "Emergency" = n.perc(substr(get(paste0(proc,'_admission_method')),1,1) == "2",dig = 3),
                                 "Length of stay (IQR)" =  median.iqr(get(paste0(proc,'_date_discharged')) - get(paste0(proc,'_date_admitted')),dig = 0),
                                 "90 day mortality" =n.perc(date.90.day(x = 'date_death_ons', ref.dat = paste0(proc,'_date_admitted')),dig = 4),
                                 "90 day COVID-19" = n.perc(date.90.day(x = paste0(proc,'_date'), ref.dat = paste0(proc,'_date_admitted')),dig = 3),
                                 n.perc(((date.90.day(x = paste0(proc,"_VTE_HES_date_admitted"), ref.dat = paste0(proc,'_date_admitted'))) |
                                 (date.90.day(x = paste0(proc,"_VTE_GP_date"), ref.dat = paste0(proc,'_date_admitted')))) &
                                 date.90.day(x = paste0(proc,"_anticoagulation_prescriptions_date"), ref.dat = paste0(proc,'_date_admitted')),dig = 4))],
                               t(dt[is.finite(get(paste0(proc,'_date_admitted'))) ,rnd(.N), keyby = region][,V1]),
                               t(dt[is.finite(get(paste0(proc,'_date_admitted'))),rnd(.N), by = .(.grp = eval(parse(text = paste0(proc,'_primary_diagnosis'))))][order(-V1), do.call(paste,c(.SD, sep = ": "))][1:5]))
    )
      }
  )
  )
  ),include.rownames = T)


rownames(demo.tab) <- c("Procedures (N)","Patients (N)","Female (%)","Median Age, years (IQR)","Median BMI (IQR)","IMD quintile (IQR)","1st Vaccination (%)","2nd Vaccination (%)","3rd Vaccination (%)","Cancer diagnosis (%)", "Emergency (%)","Median length of stay (IQR)","90 day mortality (%)","90 day COVID-19 (%)","90 day VTE","Region: Other","East of England","East Midlands","London","North East","North West","South East","South West","West Midlands","Yorkshire and the Humber", "Top 5 primary diagnoses: 1", "2","3","4","5")[1:nrow(demo.tab)]
colnames(demo.tab) <- procedures
                        
knitr::kable(demo.tab, caption = "Demographics of patients by procedure type with counts rounded to nearest 5")
```
