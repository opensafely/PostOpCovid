---
title: "Results"
author: "Colin Crooks"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_caption: true
---




```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = F, warning = F)
library(foreach)
library(data.table)
ncores <- parallel::detectCores(logical = T) - 1
data.table::setDTthreads(ncores)
max.category <- function(predi) {unique(dt.tv[!is.na(get(covariates[predi])),get(covariates[predi])], na.rm = T)[which.max(dt.tv[!is.na(get(covariates[predi])),.N, by = c(covariates[predi])][['N']])]}

source(here::here("analysis","Utils.R"))
#library(doParallel)
#ncores <- parallel::detectCores(logical = T)
#cl <- makeCluster(ncores)
#registerDoParallel(cl)
###########################################################
#https://github.com/ateucher/useful_code/blob/master/R/numbers2words.r
#https://gist.github.com/psychemedia/numbers2words.R

load(file = here::here("output","cohort_long.RData"))
procedures <- c('Abdominal','Cardiac','Obstetrics','Orthopaedic','Thoracic', 'Vascular')


## Count variables for demographic tables
dt.tv[,postVTE90.perepisode := max(post.VTE & end <=90,na.rm = T), keyby = .(patient_id, end.fu)]
dt.tv[!is.finite(postVTE90.perepisode),postVTE90.perepisode := 0]

data.table::setkey(dt.tv,patient_id,tstart,tstop)
dt.tv[ ,postCOVID30.perepisode := event == 1 & end <=30]

dt.tv[,postCOVID30.perepisode := max(postCOVID30.perepisode,na.rm = T), keyby = .(patient_id, end.fu)]
dt.tv[!is.finite(postCOVID30.perepisode),postCOVID30.perepisode := 0]

data.table::setkey(dt.tv,patient_id,tstart,tstop)

 n.ops <- rnd(dt.tv[(postop.covid.cohort) & start ==0  & is.finite(admit.date),lapply(.SD,function(x) sum(x == T)), .SDcols = c(procedures)])
 
 n.pats <- rnd(length(unique(dt.tv[(postop.covid.cohort) & start ==0 & is.finite(admit.date) & any.op == T,patient_id])))
 
 start.date <- dt.tv[(postop.covid.cohort) & start ==0 & is.finite(admit.date) & any.op == T, min(as.Date(as.integer(admit.date), origin = as.Date('1970-01-01')))]
 
 last.date <-  dt.tv[(postop.covid.cohort) & start ==0  & is.finite(admit.date) & any.op == T, max(as.Date(as.integer(admit.date), origin = as.Date('1970-01-01')))]

```

## Study population
One third of GP practices in England use SystmOne, with records for approximately 44% of the English population. `r numbers2words(n.pats)` adult patients were identified as the study population undergoing at least one procedure whilst registered to a general practitioner using the SystmOne database at the time of the first procedure between `r format(start.date, format="%B %d %Y")` and `r format(last.date, format="%B %d %Y")`. `r stringr::str_to_sentence(numbers2words(sum(n.ops)))` procedures were identified within these patients' registration period after restricting to the first 5 procedures within each category (abdominal, cardiac, obstetric, orthopaedic,  thoracic, & vascular). The numbers and demographics of these patients and procedures are shown in Table 1.

```{r demo, results='asis', echo = F, warning=F, eval = TRUE}
load(here::here("output","table_demo.RData"))

knitr::kable(demo.tab, caption = "Demographics of patients by procedure type with counts rounded to nearest 5")

```


## Post operative 90 day COVID-19 risk
Table 2 shows the cumulative risk of testing positive for COVID-19 peri-opertively for elective patients, from the operation (i.e within pre operative quarantine periods for elective procedures) to 90 days post operatively. 

```{r postopcovid, eval = T, echo=FALSE}

################################
# Post operative COVID risk model----
##################################
load(here::here("output","postopcovid_crude.RData"))
load(here::here("output","postopcovid_adjusted.RData"))

knitr::kable(broom::tidy(post.op.covid.model[[1]], exponentiate= T, conf.int = T),digits = 2)

knitr::kable(cuminc.adjusted.waves,col.names = paste0("Wave ",1:4), row.names = T, digits = 2)
```

```{r postopcovid_cuminc}
################################
# Post operative COVID risk cumulative incidence per co variate----
##################################

comb_postop_covid <- cbind(crude.covid.cov,adjusted.cuminc)

names(comb_postop_covid) <- c("Characteristic","Level","Number at risk",
                            "Number of events","30 day Cumulative Risk adjusted for censoring","30 day Cumulative Risk adjusted for death and emergency readmission","30 day Cumulative Risk adjusted for all covariates")

knitr::kable(comb_postop_covid, 
             caption = paste0("Cumulative incidence of 30 day post operative COVID of patients by procedure type with counts rounded to nearest 5. Adjusted predictions for factors set at their most frequent population values:\n procedure = ", procedures[which.max(dt.tv[,lapply(.SD,sum,na.rm = T), .SDcols = c(procedures)])], Reduce(lapply(which(covariates == 'age.cat'):which(covariates == 'previousCOVID'), function(i) paste0(covariates[i] ,' = ',max.category(which(covariates == covariates[i])))), f =function(x,y) paste(x,y, collapse = ", "))))

```

```{r postopcovid_tv}
load(file = here::here("output","postopcovid_tv.RData"))

ggplot2::ggplot(weekly.post.op.risk) + 
  ggplot2::geom_col(ggplot2::aes(x = factor(`Risk period`, level = c("Week pre discharge","1st week","2nd week","3rd week","4th week")), 
                                                                      y = Risk)) +
ggplot2::xlab("Risk Period post discharge") + 
  ggplot2::ylab("Cumulative risk during time period") + ggplot2::ggtitle("Post operative risk of COVID-19 over time",
                                                                         subtitle = "Adjusted for age, sex, SES, BMI, co-morbidity, vaccination,\n operation category, emergency, previous COVID-19, \n COVID_19 wave, and competing risks of death and readmission")

```   

# COVID impact on post operative length of stay

```{r postopLOS}

load(file = here::here("output","postoplos.RData"))

knitr::kable(broom::tidy(post.op.LOS.model, exponentiate= T, conf.int = T),digits = 2)

knitr::kable(mean.adjusted.los,col.names = paste0("Wave ",1:4), row.names = T, digits = 2)

```


# Post operative VTE risk

```{r postopVTE, results='asis'}
load(file = here::here("output","postopVTE.RData"))

knitr::kable(broom::tidy(post.op.VTE.model[[1]], exponentiate= T, conf.int = T),digits = 2)


knitr::kable(cuminc.adjusted.VTE,col.names = paste0("Wave ",1:4), row.names = T, digits = 4)


```


# COVID impact on post operative Mortality

```{r postopmortality}
knitr::kable(broom::tidy(post.op.died.model[[1]], exponentiate= T, conf.int = T),digits = 2)


knitr::kable(cuminc.adjusted.mortality,col.names = paste0("Wave ",1:4), row.names = T, digits = 4)

```

################################
# COVID impact on Emergency Readmission ----
#################################
data.table::setkey(dt.tv,"patient_id","tstart","tstop")

post.op.los.post.covid.model <- survival::coxph(survival::Surv(start,end,emergency_readmit) ~ op.type + postcovid*wave + age + sex + bmi + factor(vaccination.status, ordered = F) + Current.Cancer + Emergency + Charl12 + recentCOVID + previousCOVID, 
                                                id = patient_id, data = dt.tv[start>=0 & tstop <= readmit.end])
data.table::fwrite(broom::tidy(post.op.los.post.covid.model, exponentiate= T, conf.int = T), file = here::here("output","post_op_readmit_post_covid_model.csv"))

print(xtable::xtable(finalfit::finalfit.coxph(dt.tv[start>=0 & tstop <=  readmit.end ],
                                                        'survival::Surv(start,end,emergency_readmit)',
                                                        covariates
)), type = 'html', file = here::here("output","post_op_readmit_ff_model.html"))