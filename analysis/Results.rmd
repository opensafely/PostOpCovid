---
title: "Results"
author: "Colin Crooks"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_caption: true
---




```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = F, warning = F)
library(foreach)
library(data.table)
ncores <- parallel::detectCores(logical = T) - 1
data.table::setDTthreads(ncores)
max.category <- function(predi) {unique(dt.tv[!is.na(get(covariates[predi])),get(covariates[predi])], na.rm = T)[which.max(dt.tv[!is.na(get(covariates[predi])),.N, by = c(covariates[predi])][['N']])]}

source(here::here("analysis","Utils.R"))
#library(doParallel)
#ncores <- parallel::detectCores(logical = T)
#cl <- makeCluster(ncores)
#registerDoParallel(cl)
###########################################################
#https://github.com/ateucher/useful_code/blob/master/R/numbers2words.r
#https://gist.github.com/psychemedia/numbers2words.R

load(file = here::here("output","cohort_long.RData"))
procedures <- c('Abdominal','Cardiac','Obstetrics','Orthopaedic','Thoracic', 'Vascular')


data.table::setkey(dt.tv,patient_id,tstart,tstop)
dt.tv[,final.date := covid.end]
dt.tv[is.finite(readmit.end) & readmit.end < final.date, final.date := readmit.end]
dt.tv[is.finite(end.fu) & end.fu < final.date, final.date := end.fu]

dt.tv[,event :=0]
dt.tv[COVIDpositivedate == tstop, event := 1]
dt.tv[emergency_readmitdate  == tstop & event != 1, event := 2]
dt.tv[date_death_ons == tstop & event != 1, event := 3]

data.table::setkey(dt.tv,patient_id,tstart,tstop)
dt.tv[, postop.covid.cohort := start>=0 & tstop <= final.date & end <= 90]
dt.tv[,postVTE90.perepisode := max(post.VTE & end <=90,na.rm = T), keyby = .(patient_id, end.fu)]
dt.tv[!is.finite(postVTE90.perepisode),postVTE90.perepisode := 0]

data.table::setkey(dt.tv,patient_id,tstart,tstop)
dt.tv[ ,postCOVID30.perepisode := event == 1 & end <=30]

dt.tv[,postCOVID30.perepisode := max(postCOVID30.perepisode,na.rm = T), keyby = .(patient_id, end.fu)]
dt.tv[!is.finite(postCOVID30.perepisode),postCOVID30.perepisode := 0]

data.table::setkey(dt.tv,patient_id,tstart,tstop)

dt.tv[(postop.covid.cohort) & start ==0  & is.finite(admit.date),any.op := rowSums(.SD,na.rm =T), .SDcols = c(procedures)]
dt.tv[is.na(any.op), any.op := F]
dt.tv[, any.op := max(any.op,na.rm = T), by = .(patient_id, end.fu)]

dt.tv[, postop.covid.cohort := start>=0 & tstop <= final.date & end <= 90 & any.op == T]


 n.ops <- rnd(dt.tv[(postop.covid.cohort) & start ==0  & is.finite(admit.date),lapply(.SD,function(x) sum(x == T)), .SDcols = c(procedures)])
 
 n.pats <- rnd(length(unique(dt.tv[(postop.covid.cohort) & start ==0 & is.finite(admit.date) & any.op == T,patient_id])))
 
 start.date <- dt.tv[(postop.covid.cohort) & start ==0 & is.finite(admit.date) & any.op == T, min(as.Date(as.integer(admit.date), origin = as.Date('1970-01-01')))]
 
 last.date <-  dt.tv[(postop.covid.cohort) & start ==0  & is.finite(admit.date) & any.op == T, max(as.Date(as.integer(admit.date), origin = as.Date('1970-01-01')))]

```

## Study population
One third of GP practices in England use SystmOne, with records for approximately 44% of the English population. `r numbers2words(n.pats)` adult patients were identified as the study population undergoing at least one procedure whilst registered to a general practitioner using the SystmOne database at the time of the first procedure between `r format(start.date, format="%B %d %Y")` and `r format(last.date, format="%B %d %Y")`. `r stringr::str_to_sentence(numbers2words(sum(n.ops)))` procedures were identified within these patients' registration period after restricting to the first 5 procedures within each category (abdominal, cardiac, obstetric, orthopaedic,  thoracic, & vascular). The numbers and demographics of these patients and procedures are shown in Table 1.

```{r demo, results='asis', echo = F, warning=F, eval = TRUE}

demo.tab <- 
  data.table::transpose(cbind(data.table::data.table("procedures" = procedures),
                              foreach::foreach(i = 1:length(procedures), .combine = 'rbind', .inorder = T) %do% dt.tv[(postop.covid.cohort) & start ==0  & final.date >= tstop & any.op == T & get(paste0(procedures[i])) == T,
      .("Procedures" = rnd(.N),
        "Patients" = rnd(length(unique(patient_id))),
        "Female" = n.perc(sex=='F',dig = 3),
        "Age (IQR)" = median.iqr(age,dig = 0),
        "BMI < 19" =  n.perc(as.numeric(bmi.cat) ==  1, dig  = 3),
        "BMI 19-24" =  n.perc(as.numeric(bmi.cat) ==  2, dig  = 3),
        "BMI 15-29" =  n.perc(as.numeric(bmi.cat) ==  3, dig  = 3),
        "BMI > 30" =  n.perc(as.numeric(bmi.cat) ==  4, dig  = 3),
        "IMD quintile 1" = n.perc(as.numeric(imd5) ==  1, dig  = 3),
        "IMD quintile 2" = n.perc(as.numeric(imd5) ==  2, dig  = 3),
        "IMD quintile 3" = n.perc(as.numeric(imd5) ==  3, dig  = 3),
        "IMD quintile 4" = n.perc(as.numeric(imd5) ==  4, dig  = 3),
        "IMD quintile 5" = n.perc(as.numeric(imd5) ==  5, dig  = 3),
        "Wave 1" = n.perc(wave == 'Wave_1', dig = 3),
        "Wave 2" = n.perc(wave == 'Wave_2', dig = 3),
        "Wave 3" = n.perc(wave == 'Wave_3', dig = 3),
        "Wave 4" = n.perc(wave == 'Wave_4', dig = 3),
        "1st Vaccination" = n.perc(vaccination.status.factor==1,dig = 3),
        "2nd Vaccination" = n.perc(vaccination.status.factor==2,dig = 3),
        "3rd Vaccination" = n.perc(vaccination.status.factor==3,dig = 3),
        "Current Cancer"  = n.perc(substr(primary_diagnosis,1,1) =='C',dig = 3),
        "Emergency" = n.perc(substr(admission_method,1,1) == "2",dig = 3),
        "Charlson index" = median.iqr(Charlson, dig = 1),
        "Length of stay (IQR)" =  median.iqr(discharge.date - admit.date,dig = 0),
        "90 day mortality (%)" =n.perc(date.90.day(x = date_death_ons, ref.dat = admit.date),dig = 4),
        "30 day COVID-19 (%)" = n.perc(postCOVID30.perepisode, dig = 3),
        "Recent COVID_19 (%)" = paste0(rnd(sum(recentCOVID, na.rm = T))," (", round(100*mean(recentCOVID != "", na.rm = T), digits = 1),"%)"),
        "Previous COVID_19 (%)" = paste0(rnd(sum(previousCOVID, na.rm = T))," (", round(100*mean(previousCOVID != "", na.rm = T), digits = 1),"%)"),
        "90 day VTE (%)" = n.perc(postVTE90.perepisode, dig = 4))],
  data.table::transpose(
  cbind(
    data.table::transpose(
          dt.tv[(postop.covid.cohort) & start ==0,
      lapply(.SD,function(x) rnd(sum(x))),
      keyby = region, .SDcols = c(procedures)],
      keep.names = "procedure",make.names = "region")[,
                         lapply(.SD,
                                function(x) paste0(x,
                                                   ' (',
                                                   round(100*x/sum(x,na.rm = T),
                                                         digits = 1),
                                                   '%)')
                                ),
                         .SDcols = 2:7],
    sort(unique(dt.tv$region))
    ),
  make.names = "V2"),
  data.table::transpose(
  cbind(1:5,
            dt.tv[(postop.covid.cohort) & start ==0,
      lapply(.SD,function(x) rnd(sum(x))),
                  keyby = c('primary_diagnosis'), .SDcols = c(procedures)][,
                                        lapply(.SD,
                                               function(x) paste0(primary_diagnosis,
                                                                  ": ",
                                                                  x,
                                                                  ' (',
                                                                  round(100*x/sum(x,na.rm = T),
                                                                        digits = 1),
                                                                  '%)')[order(-x)]),
                                        .SDcols = 2:7][1:5,]),
  make.names = 'V1')
),
make.names = 'procedures',
keep.names = 'Characteristics')

                        
knitr::kable(demo.tab, caption = "Demographics of patients by procedure type with counts rounded to nearest 5")

```


## Post operative 90 day COVID-19 risk
Table 2 shows the cumulative risk of testing positive for COVID-19 peri-opertively for elective patients, from 7 days prior to the operation (i.e within pre operative quarantine periods for elective procedures) to 90 days post operatively. 

```{r cuminc, results='asis', echo = F, warning=FALSE, eval=T}

covariates <- c(procedures,'age.cat','sex','bmi.cat','imd5','wave',
                'vaccination.status.factor','region','Current.Cancer','Emergency','Charl12','recentCOVID','previousCOVID')

data.table::setkey(dt.tv,patient_id,tstart,tstop)

crude.covid.cov <- data.table::rbindlist(lapply(1:length(covariates), function(i) cbind(rep(covariates[i],length(levels(dt.tv[(postop.covid.cohort),as.factor(get(covariates[i]))]))),                                    levels(dt.tv[(postop.covid.cohort),as.factor(get(covariates[i]))]),
                                    cuminc.km(covariates[i], niter = 2)[,2:5])))

names(crude.covid.cov) <- c("Characteristic","Level","Number at risk",
                            "Number of events","30 day Cumulative Risk adjusted for censoring","30 day Cumulative Risk adjusted for death and emergency readmission")

save(crude.covid.cov, file = here::here("output","bootstrap.RData"))



```


```{r, eval = T, echo=FALSE}

################################
# Post operative COVID risk ----
##################################
data.table::setkey(dt.tv,"patient_id","tstart","tstop")
dt.tv[,age.cat := factor(age.cat, order = F)]

post.op.covid.model <- 
  lapply(1:3, function(i) survival::coxph(survival::Surv(start,end,event==i) ~ Abdominal + Cardiac + Obstetrics + Orthopaedic + Thoracic + Vascular + age.cat + sex + bmi.cat + imd5 + wave + vaccination.status.factor + region + Current.Cancer + Emergency + Charl12 + recentCOVID + previousCOVID, id = patient_id,
                  data = dt.tv[(postop.covid.cohort)], model = T))

knitr::kable(broom::tidy(post.op.covid.model[[1]], exponentiate= T, conf.int = T))

n.type.events <- sort(unique(dt.tv[(postop.covid.cohort) ,event]))[-1]
cuminc.adjusted <- 100*round(matrix(apply(exp(apply((log((1 - Reduce('+',lapply(n.type.events, function(i) outer(survival::basehaz(post.op.covid.model[[i]],centered = F)[,1] -
                                                         c(0,head(survival::basehaz(post.op.covid.model[[i]],centered = F)[,1],-1)),
                                                       exp(predict(object = post.op.covid.model[[i]],
                                                                   type = 'lp', 
                                                                   newdata = data.table::data.table(
                                                                    'start' = rep(0,8),
                                                                    'end' = rep(30,8*length(procedures)),
                                                                    'event' = rep(F,8*length(procedures)),
                                                                    'Abdominal' = c(rep(T,2),rep(F,10)),
                                                                    'Cardiac'=c(rep(F,2),rep(T,2),rep(T,8)),
                                                                    'Obstetrics'=c(rep(F,4),rep(T,2),rep(F,6)),
                                                                    'Orthopaedic'=c(rep(F,6),rep(T,2),rep(F,4)),
                                                                    'Thoracic'=c(rep(F,8),rep(T,2),rep(F,2)),
                                                                    'Vascular'=c(rep(F,10),rep(T,2)),
                                                                    'age.cat' = rep('(50,70]',8*length(procedures)),
                                                                    'sex' = rep('F',8*length(procedures)),
                                                                    'bmi.cat' = rep(levels(dt.tv$bmi.cat)[2],8*length(procedures)),
                                                                    'imd5' = rep(levels(dt.tv$imd5)[3], 8*length(procedures)),
                                                                    'wave' = rep(paste0('Wave_',1:4),times = 2*length(procedures)),
                                                                    'vaccination.status.factor' = rep('3',8*length(procedures)),
                                                                    'region' = rep("East Midlands",8*length(procedures)),
                                                                    'Current.Cancer' = rep(T,8*length(procedures)),
                                                                    'Emergency' =  rep(c(rep(F,4),rep(T,4)), times = length(procedures)),
                                                                    'Charl12' =  rep('Single',8*length(procedures)),
                                                                    'recentCOVID' = rep(F,8*length(procedures)),
                                                                    'previousCOVID' = rep(F,8*length(procedures)),
                                                                    'patient_id' = 1:(8*length(procedures))))),'*')))))),
                 2,cumsum))*
        outer(survival::basehaz(post.op.covid.model[[1]],centered = F)[,1] -
                                                         c(0,head(survival::basehaz(post.op.covid.model[[1]],centered = F)[,1],-1)),
         exp(predict(object = post.op.covid.model[[1]],
                                                                   type = 'lp', 
                                                                   newdata = data.table::data.table(
                                                                    'start' = rep(0,8),
                                                                    'end' = rep(30,8*length(procedures)),
                                                                    'event' = rep(F,8*length(procedures)),
                                                                    'Abdominal' = c(rep(T,2),rep(F,10)),
                                                                    'Cardiac'=c(rep(F,2),rep(T,2),rep(T,8)),
                                                                    'Obstetrics'=c(rep(F,4),rep(T,2),rep(F,6)),
                                                                    'Orthopaedic'=c(rep(F,6),rep(T,2),rep(F,4)),
                                                                    'Thoracic'=c(rep(F,8),rep(T,2),rep(F,2)),
                                                                    'Vascular'=c(rep(F,10),rep(T,2)),
                                                                    'age.cat' = rep('(50,70]',8*length(procedures)),
                                                                    'sex' = rep('F',8*length(procedures)),
                                                                    'bmi.cat' = rep(levels(dt.tv$bmi.cat)[2],8*length(procedures)),
                                                                    'imd5' = rep(levels(dt.tv$imd5)[3], 8*length(procedures)),
                                                                    'wave' = rep(paste0('Wave_',1:4),times = 2*length(procedures)),
                                                                    'vaccination.status.factor' = rep('3',8*length(procedures)),
                                                                    'region' = rep("East Midlands",8*length(procedures)),
                                                                    'Current.Cancer' = rep(T,8*length(procedures)),
                                                                    'Emergency' =  rep(c(rep(F,4),rep(T,4)), times = length(procedures)),
                                                                    'Charl12' =  rep('Single',8*length(procedures)),
                                                                    'recentCOVID' = rep(F,8*length(procedures)),
                                                                    'previousCOVID' = rep(F,8*length(procedures)),
                                                                    'patient_id' = 1:(8*length(procedures)))))),
      2,cumsum)[30,], byrow = T, ncol = 4), digits = 3)

rownames(cuminc.adjusted) <- c(paste0(rep(procedures,each = 2), 
                                    rep(c(F,T), times = length(procedures))))

knitr::kable(cuminc.adjusted,col.names = paste0("Wave ",1:4), row.names = T, digits = 2)
```

```{r}
load(file = here::here("output","bootstrap.RData"))
library(foreach)
################################
# Post operative COVID risk ----
##################################
data.table::setkey(dt.tv,"patient_id","tstart","tstop")
dt.tv[,age.cat := factor(age.cat, order = F)]

post.op.covid.model <- 
  lapply(1:3, function(i) survival::coxph(survival::Surv(start,end,event==i) ~ Cardiac + Obstetrics + Orthopaedic + Thoracic + Vascular + age.cat + sex + bmi.cat + imd5 + wave + vaccination.status.factor + region + Current.Cancer + Emergency + Charl12 + recentCOVID + previousCOVID, id = patient_id,
                  data = dt.tv[(postop.covid.cohort)], model = T))

dt.tv[,age.cat := factor(age.cat, order = F)]


n.type.events <- sort(unique(dt.tv[(postop.covid.cohort) ,event]))[-1]

adjusted.cuminc <- cbind(crude.covid.cov,
                         foreach::foreach(predi = 1:length(covariates), .combine = 'c', .inorder = T) %do% {
newdata.rows <- length(unique(dt.tv[!is.na(get(covariates[predi])),get(covariates[predi])]))

newdata.pred <- data.table::data.table('start' = rep(0,newdata.rows),
                                       'end' = rep(30,newdata.rows),
                                       'event' = rep(F,newdata.rows),
                                       'patient_id' = 1:newdata.rows)

newdata.pred[,(procedures) := lapply(procedures, function(x) x == procedures[which.max(dt.tv[,lapply(.SD,sum,na.rm = T), .SDcols = c(procedures)])])]

newdata.pred[,(covariates[-c(1:length(procedures))]) := lapply(((length(procedures)+1):length(covariates)), function(i.c) {
  if(is.factor(dt.tv[!is.na(get(covariates[i.c])),get(covariates[i.c])])) {
    as.character(rep(max.category(i.c),newdata.rows))
  } else if(is.logical(dt.tv[!is.na(get(covariates[i.c])),get(covariates[i.c])])) {
    as.logical(rep(max.category(i.c),newdata.rows))
  } else if(is.numeric(dt.tv[!is.na(get(covariates[i.c])),get(covariates[i.c])])) {
    is.numeric(rep(max.category(i.c),newdata.rows))
  } else {
    rep(max.category(i.c),newdata.rows)
  }
})]

#names(newdata.pred) <- c('start','end','event', covariates,'patient_id') 
if(is.factor(dt.tv[!is.na(get(covariates[predi])),get(covariates[predi])])) {
  newdata.pred[,(covariates[predi]) :=  as.character(sort(unique(dt.tv[!is.na(get(covariates[predi])),get(covariates[predi])], na.rm = T)))]
  } else if(is.logical(dt.tv[!is.na(get(covariates[predi])),get(covariates[predi])])) {
  newdata.pred[,(covariates[predi]) :=  as.logical(sort(unique(dt.tv[!is.na(get(covariates[predi])),get(covariates[predi])], na.rm = T)))]
  } else if(is.numeric(dt.tv[!is.na(get(covariates[predi])),get(covariates[predi])])) {
  newdata.pred[,(covariates[predi]) :=  is.numeric(sort(unique(dt.tv[!is.na(get(covariates[predi])),get(covariates[predi])], na.rm = T)))]
  } else {
  newdata.pred[,(covariates[predi]) := sort(unique(dt.tv[!is.na(get(covariates[predi])),get(covariates[predi])], na.rm = T))]
}
  



100*round(matrix(apply(exp(apply((log((1 - Reduce('+',lapply(n.type.events, function(i) outer(survival::basehaz(post.op.covid.model[[i]],centered = F)[,1] -
c(0,head(survival::basehaz(post.op.covid.model[[i]],centered = F)[,1],-1)),
                                                       exp(predict(object = post.op.covid.model[[i]],
                                                                   type = 'lp', 
                                                                   newdata = newdata.pred)),'*')))))),
                 2,cumsum))*
        outer(survival::basehaz(post.op.covid.model[[1]],centered = F)[,1] -
                                                         c(0,head(survival::basehaz(post.op.covid.model[[1]],centered = F)[,1],-1)),
         exp(predict(object = post.op.covid.model[[1]],
                                                                   type = 'lp', 
                                                                   newdata = newdata.pred))),
      2,cumsum)[30,], byrow = T, ncol = 1), digits = 3)
})

names(adjusted.cuminc) <- c("Characteristic","Level","Number at risk",
                            "Number of events","30 day Cumulative Risk adjusted for censoring","30 day Cumulative Risk adjusted for death and emergency readmission","30 day Cumulative Risk adjusted for all covariates")

knitr::kable(adjusted.cuminc, caption = paste0("Cumulative incidence of 30 day post operative COVID of patients by procedure type with counts rounded to nearest 5. Adjusted predictions for factors set at their most frequent population values:\n procedure = ", procedures[which.max(dt.tv[,lapply(.SD,sum,na.rm = T), .SDcols = c(procedures)])], 
                                               Reduce(lapply(which(covariates == 'age.cat'):which(covariates == 'previousCOVID'), function(i) paste0(covariates[i] ,' = ',max.category(which(covariates == covariates[i])))), f =function(x,y) paste(x,y, collapse = ", "))))

```

```{r}
dt.tv[,`:=`(post.disch.wk1 = discharge.date + 7 ,
            post.disch.wk2 = discharge.date + 14 ,
            post.disch.wk3 = discharge.date + 21 ,
            post.disch.wk4 = discharge.date + 28 ,
            covid.event = event == 1,
            censor.event = event!=1)]


dt.tv.splits <- data.table::melt(dt.tv[is.finite(discharge.date),tail(.SD,1),
                                       .SDcols = c(paste0("post.disch.wk",1:4)),
                                       keyby = c('patient_id')], 
                                 id.vars = c('patient_id'),
                                 value.name = "post.disch.wk",
                                 variable.name = "week.post.disch" )[
                                   order(patient_id, week.post.disch),][,
                                                                       `:=` (tstart = post.disch.wk,
                                                                             week.post.disch = as.numeric(gsub(".*?([0-9]+).*",'\\1',week.post.disch)))][
                                                                         ,.(patient_id, week.post.disch,tstart)]

#
dt.tv[,week.post.disch := NA]
dt.tv.splits <- data.table::rbindlist(list(dt.tv.splits,dt.tv[,.(patient_id, week.post.disch, tstart)]))
dt.tv.splits[,post.disch.wk := tstart]
data.table::setkey(dt.tv.splits,patient_id, tstart)
dt.tv[,week.post.disch := NULL]
dt.tv.splits <- dt.tv[dt.tv.splits,,roll = Inf, on = .(patient_id,tstart)]

dates.expand.start.align_(dt = 'dt.tv.splits',
                          start.DTTM = 'tstart',
                          end.DTTM = 'tstop',
                          ID = 'patient_id',
                          merged.DTTM = 'post.disch.wk')

dates.expand.end.align_(dt = 'dt.tv.splits',
                          start.DTTM = 'tstart',
                          end.DTTM = 'tstop',
                          ID = 'patient_id',
                          merged.DTTM = 'post.disch.wk')

locf.roll_(dt = 'dt.tv.splits',
           ID = 'patient_id',
           start.DTTM = 'tstart',
           group = 'c("patient_id","end.fu")',
           var.cols = 'c("week.post.disch")')

dt.tv.splits[tstart >= admit.date & (!is.finite(discharge.date) | tstop <= discharge.date), week.post.disch := 0 ]

dt.tv.splits[,week.post.disch := as.factor(week.post.disch)]
dt.tv.splits[, los.end := min(los.end, na.rm = T), keyby = .(patient_id, end.fu)]

dt.tv.splits[, `:=`(start = tstart - los.end,
             end = tstop - los.end)]
data.table::setkey(dt.tv.splits, patient_id, end.fu, start)
post.op.covid.model.split <- 
  lapply(1:3, function(i) survival::coxph(survival::Surv(start,end,event==i) ~ week.post.disch + Cardiac + Obstetrics + Orthopaedic + Thoracic + Vascular + age.cat + sex + bmi.cat + imd5 + wave + vaccination.status.factor + region + Current.Cancer + Emergency + Charl12 + recentCOVID + previousCOVID, id = patient_id,
                  data = dt.tv.splits[(postop.covid.cohort) ], model = T))


newdata.rows <- length(levels(dt.tv.splits$week.post.disch))
newdata.pred <- data.table::data.table('start' = c(-7,0,7,14,21),
                                       'end' = c(0,7,14,21,28),
                                       'event' = rep(F,newdata.rows),
                                       'patient_id' = 1:newdata.rows,
                                       'week.post.disch' = paste(0:(newdata.rows - 1)))

newdata.pred[,(procedures) := lapply(procedures, function(x) x == procedures[which.max(dt.tv[,lapply(.SD,sum,na.rm = T), .SDcols = c(procedures)])])]

newdata.pred[,(covariates[-c(1:length(procedures))]) := lapply(((length(procedures)+1):length(covariates)), function(i.c) {
  if(is.factor(dt.tv[!is.na(get(covariates[i.c])),get(covariates[i.c])])) {
    as.character(rep(max.category(i.c),newdata.rows))
  } else if(is.logical(dt.tv[!is.na(get(covariates[i.c])),get(covariates[i.c])])) {
    as.logical(rep(max.category(i.c),newdata.rows))
  } else if(is.numeric(dt.tv[!is.na(get(covariates[i.c])),get(covariates[i.c])])) {
    is.numeric(rep(max.category(i.c),newdata.rows))
  } else {
    rep(max.category(i.c),newdata.rows)
  }
})]

weekly.post.op.risk <- 
  round(100*apply(exp(apply((log((1 - Reduce('+',lapply(n.type.events, function(i) outer((survival::basehaz(post.op.covid.model.split[[i]],centered = F)[,1] -
c(0,head(survival::basehaz(post.op.covid.model.split[[i]],centered = F)[,1],-1))),
                                                       exp(predict(object = post.op.covid.model.split[[i]],
                                                                   type = 'lp', 
                                                                   newdata = newdata.pred)),'*')))))),
                 2,cumsum))*
        outer(survival::basehaz(post.op.covid.model.split[[1]],centered = F)[,1] -
                                                         c(0,head(survival::basehaz(post.op.covid.model.split[[1]],centered = F)[,1],-1)),
         exp(predict(object = post.op.covid.model.split[[1]],
                                                                   type = 'lp', 
                                                                   newdata = newdata.pred))),
      2,cumsum), digits = 2)

weekly.post.op.risk[!is.finite(weekly.post.op.risk)] <- 0

weekly.post.op.risk <- c(weekly.post.op.risk[max(which(survival::basehaz(post.op.covid.model.split[[1]],centered = F)$time <= 0)),1],
weekly.post.op.risk[max(which(survival::basehaz(post.op.covid.model.split[[1]],centered = F)$time <= 7)),2],
weekly.post.op.risk[max(which(survival::basehaz(post.op.covid.model.split[[1]],centered = F)$time <= 14)),3],
weekly.post.op.risk[max(which(survival::basehaz(post.op.covid.model.split[[1]],centered = F)$time <= 21)),4],
weekly.post.op.risk[max(which(survival::basehaz(post.op.covid.model.split[[1]],centered = F)$time <= 28)),5])

weekly.post.op.risk<-  data.table::data.table("Risk" = weekly.post.op.risk - c(0,weekly.post.op.risk[-length(weekly.post.op.risk)]),
                        "Risk period" = c("Inpatient","1st week","2nd week","3rd week","4th week"))

ggplot2::ggplot(weekly.post.op.risk) + 
  ggplot2::geom_col(ggplot2::aes(x = factor(`Risk period`, level = c("Inpatient","1st week","2nd week","3rd week","4th week")), 
                                                                      y = Risk)) +
ggplot2::xlab("Risk Period post discharge") + 
  ggplot2::ylab("Cumulative risk during time period") + ggplot2::ggtitle("Post operative risk of COVID-19 over time",
                                                                         subtitle = "Adjusted for age, sex, SES, BMI, co-morbidity, vaccination,\n operation category, emergency, previous COVID-19, \n COVID_19 wave, and competing risks of death and readmission")

```   