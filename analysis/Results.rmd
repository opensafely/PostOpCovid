---
title: "Results"
author: "Colin Crooks"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_caption: true
---




```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library(doParallel)
#ncores <- parallel::detectCores(logical = T)
#cl <- makeCluster(ncores)
#registerDoParallel(cl)
###########################################################
#https://github.com/ateucher/useful_code/blob/master/R/numbers2words.r
#https://gist.github.com/psychemedia/numbers2words.R
numbers2words <- function(x){
  ## Function by John Fox found here: 
  ## http://tolstoy.newcastle.edu.au/R/help/05/04/2715.html
  ## Tweaks by AJH to add commas and "and"
  helper <- function(x){
    
    digits <- rev(strsplit(as.character(x), "")[[1]])
    nDigits <- length(digits)
    if (nDigits == 1) as.vector(ones[digits])
    else if (nDigits == 2)
      if (x <= 19) as.vector(teens[digits[1]])
    else trim(paste(tens[digits[2]],
                    Recall(as.numeric(digits[1]))))
    else if (nDigits == 3) trim(paste(ones[digits[3]], "hundred and", 
                                      Recall(makeNumber(digits[2:1]))))
    else {
      nSuffix <- ((nDigits + 2) %/% 3) - 1
      if (nSuffix > length(suffixes)) stop(paste(x, "is too large!"))
      trim(paste(Recall(makeNumber(digits[
        nDigits:(3*nSuffix + 1)])),
        suffixes[nSuffix],"," ,
        Recall(makeNumber(digits[(3*nSuffix):1]))))
    }
  }
  trim <- function(text){
    #Tidy leading/trailing whitespace, space before comma
    text=gsub("^\ ", "", gsub("\ *$", "", gsub("\ ,",",",text)))
    #Clear any trailing " and"
    text=gsub(" and$","",text)
    #Clear any trailing comma
    gsub("\ *,$","",text)
  }  
  makeNumber <- function(...) as.numeric(paste(..., collapse=""))     
  #Disable scientific notation
  opts <- options(scipen=100) 
  on.exit(options(opts)) 
  ones <- c("", "one", "two", "three", "four", "five", "six", "seven",
            "eight", "nine") 
  names(ones) <- 0:9 
  teens <- c("ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen",
             "sixteen", " seventeen", "eighteen", "nineteen")
  names(teens) <- 0:9 
  tens <- c("twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty",
            "ninety") 
  names(tens) <- 2:9 
  x <- round(x)
  suffixes <- c("thousand", "million", "billion", "trillion")     
  if (length(x) > 1) return(trim(sapply(x, helper)))
  helper(x)
  }
  
  rnd <- function(x) floor(x/5)*5
  
  median.iqr <- function(x, dig=0) paste0(round(median(x, na.rm = T))," (",paste(round(quantile(x,c(0.25,0.75),na.rm = T),digits = dig),collapse = ","),")")
  
  n.perc <- function(x, dig=0) paste0(rnd(sum(x == T, na.rm = T))," (",round(mean(x,na.rm = T),digits = dig)*100,"%)")
  
  date.90.day <- function(x,ref.dat) is.finite(x) & as.numeric(x) - as.numeric(ref.dat) <= 90  & as.numeric(x) - as.numeric(ref.dat) >=0
   date.30.day <- function(x,ref.dat) is.finite(x) & as.numeric(x) - as.numeric(ref.dat) <= 30  & as.numeric(x) - as.numeric(ref.dat) >=0
 
  safelog <- function(x) { x[x < 1e-200] <- 1e-200; log(x) }
  
  cuminc.km <- function(x,niter)  { 
    safelog <- function(x) { x[x < 1e-200] <- 1e-200; log(x) }
    n.type.events <- sort(unique(dt.tv[(postop.covid.cohort) & !is.na(get(x)),event]))[-1]
    data.table::setkey(dt.tv, patient_id, tstart,tstop)
    est <- boot.est <- Reduce(function(x, y) merge(x, y, by = c("strata",'time'),all = T,sort = T, incomparables = 0),
                              lapply(n.type.events, function(i) data.table::setDT(summary(survival::survfit(survival::Surv(start,end,event==i) ~ get(x), 
                                                                                 data = dt.tv[(postop.covid.cohort) & !is.na(get(x))], 
                                                                                 id = patient_id),
                                                               times = sort(unique(dt.tv[(postop.covid.cohort) & event == i & !is.na(get(x)),end])), extend = T
    )[c('strata','time','n.risk', 'n.event')])[,(paste0('haz',i)) := n.event/n.risk][,c(1,2,5)])
    )[,(paste0('haz',n.type.events)) := lapply(.SD, function(x) data.table::fifelse(is.na(x),0,x)), .SDcols = paste0('haz',n.type.events)][
      order(strata,time),
      .(time,cumsum(exp(cumsum(log(1 - Reduce('+',.SD))))*haz1)),
      keyby = strata, 
      .SDcols = paste0('haz',n.type.events)][order(strata,time),
                                   round(tail(V2,1),digits = 3)*100, 
                                   keyby = strata] 
  
#  boot.est<- foreach::foreach(iter = 1:niter, .combine = 'cbind',.multicombine = T,.export = 'dt.tv',.packages = 'data.table') %dopar% {

  for(iter in 1:niter) {
    samp.patient_id <- dt.tv[patient_id %in% sort(sample(unique(dt.tv[(postop.covid.cohort) & !is.na(get(x)),patient_id]), replace = T))]
    data.table::setkey(dt.tv, patient_id, tstart,tstop)
     boot.est <- cbind(boot.est,Reduce(function(x, y) merge(x, y, by = c("strata",'time'),all = T,sort = T, incomparables = 0),
                                       lapply(n.type.events,
                                    function(i) {
       event.times = sort(unique(dt.tv[(postop.covid.cohort) & !is.na(get(x)) & event == i,end]))
       if(samp.patient_id[(event==i),.N] > 0) {
          data.table::setDT(summary(survival::survfit(survival::Surv(start,end,event==i) ~ get(x), 
      data = samp.patient_id,
      id = patient_id),
      times = event.times,
      extend = T
      )[c('strata','time','n.risk', 'n.event')])[,(paste0('haz',i)) := n.event/n.risk][,c(1,2,5)]
       }
       else {
        data.table::data.table('strata' = rep(levels(est[[1]]), 
                                              each = length(event.times)),
                               'time' = rep(event.times, 
                                            times = length(levels(est[[1]]))))[,(paste0('haz',i)) := 0] 
       }
     }
    )
)[,(paste0('haz',n.type.events)) := lapply(.SD, function(x) data.table::fifelse(is.na(x),0,x)),
  .SDcols = paste0('haz',n.type.events)][
  order(strata,time),.(time,
                       cumsum(exp(cumsum(safelog(1 - Reduce('+',.SD))))*haz1)),
  keyby = strata, 
  .SDcols = paste0('haz',n.type.events)][order(strata,time),
                                         round(tail(V2,1),digits = 3)*100,
                                         keyby = strata][,2])
}
  return(cbind(est[,1],
               rnd(dt.tv[(postop.covid.cohort) & !is.na(get(x)) & start == 0,.N, keyby = list(get(x))][,2]),
               rnd(data.table::setDT(summary(survival::survfit(survival::Surv(start,end,event==1) ~ get(x), 
                   data = dt.tv[(postop.covid.cohort) & !is.na(get(x)),],
                   id = patient_id), times = 30)[c('n.event')])),
               est[,2],
               t(apply(boot.est[,2:(iter + 1)],1,quantile,c(0.025,0.975), na.rm = T))))
  }

##########################################################


#########################
# Basic counts and descriptions from raw data
#############################
# index_date <- data.table::as.IDate("2020-02-01")
# dt <- data.table::fread(here::here("output", "input.csv"))
# 
# procedures <- c('Abdominal','Cardiac','Obstetrics','Orthopaedic','Thoracic', 'Vascular')
# procs <- paste0(rep(procedures,each = 5),"_",1:5)
# 
# dt[,dateofbirth := (data.table::as.IDate(paste0(dob,'-15')))]
# dt[dereg_date != "",gp.end := data.table::as.IDate(paste0(dereg_date,'-15'))]
# dt[, imd := as.numeric(imd)]
# dt[, imd5 := cut(imd, breaks = seq(0,33000,33000/5),  include.lowest = T, ordered_result = F)]
# dt[bmi == 0, bmi := NA]
# dt[, bmi.cat := cut(bmi, breaks = c(0,18,24,29,100),  include.lowest = T, ordered_result = F)]
# 
# ####################################################################
# # Multiple operations per row. Reshape to long format
# ####################################################################
# 
# 
# ####### Reshape repeated procedures within a specialty
# repeated.vars <- names(dt)[grepl(pattern = paste(procedures,collapse = '|'),x = names(dt))]
# non.op.vars <- names(dt)[!grepl(pattern = paste(procedures,collapse = '|'),x = names(dt))]
# 
# aggregate_operations <- data.table::melt(dt, id.var = 'patient_id',
#                      measure = patterns(as.vector(outer(paste0(procedures,'_[0-9]'),
#                 unique(gsub(pattern = paste0(as.vector(outer(procedures,paste0("_",1:5),paste0)),collapse = "|"),replacement = "",x = paste0(repeated.vars,'$'))),
#                 paste0))),
#                 variable.name = 'op.number',
#                 value.name = as.vector(outer(procedures,unique(gsub(pattern = paste0(as.vector(outer(procedures,paste0("_",1:5),paste0)),collapse = "|"),replacement = "",x = repeated.vars)),paste0)))[order(patient_id,op.number)]
# 
# aggregate_operations <- aggregate_operations[(!is.na(Abdominal_date_admitted)|!is.na(Cardiac_date_admitted)|!is.na(Obstetrics_date_admitted)|!is.na(Orthopaedic_date_admitted)|!is.na(Thoracic_date_admitted)|!is.na(Vascular_date_admitted))]
# 
# 
# ####### Reshape repeated procedures within a specialty
# repeated.vars <- names(aggregate_operations)[grepl(pattern = paste(procedures,collapse = '|'),x = names(aggregate_operations))]
# 
# aggregate_operations <- data.table::melt(aggregate_operations, id.var = 'patient_id',
#                                          measure = patterns(as.vector(outer(paste0('(',paste0(procedures, collapse = '|'),')_'),
#                                                                             unique(gsub(pattern = paste0(paste0(procedures,"_"),collapse = "|"),replacement = "",x = paste0(repeated.vars,'$'))),
#                                                                             paste0))),
#                                          variable.name = 'op.type', 
#                                          variable.factor = T,
#                                          value.name = unique(gsub(pattern = paste0(paste0(procedures,"_"),collapse = "|"),replacement = "",x = repeated.vars)))[order(patient_id,date_admitted, op.type)]
# 
# aggregate_operations <- aggregate_operations[!is.na(date_admitted)]
# 
# aggregate_operations[,op.type := factor(op.type, levels = 1:6, labels = procedures)]
# 
# dt <- dt[,non.op.vars, with = F][aggregate_operations, on = "patient_id"]
# rm(aggregate_operations)
# 
# 
# dt[, keep := F]
# dt[!is.na(dereg_date), dereg_date := data.table::as.IDate(paste0(dereg_date,"-30"), format = "%Y-%m-%d")]
# dt[!is.na(date_admitted) &  (is.na(dereg_date) | as.numeric(date_admitted) <= dereg_date), keep := T] 
# dt <- dt[keep == T,]
# 

# 
# dt[,admit.wave := cut(as.numeric(date_admitted),
#                 breaks =
#                   c(as.numeric(data.table::as.IDate("2020-01-01", format = "%Y-%m-%d")), 
#                     as.numeric(data.table::as.IDate("2020-09-01", format = "%Y-%m-%d")),                                       
#                     as.numeric(data.table::as.IDate("2021-05-01", format = "%Y-%m-%d")),
#                     as.numeric(data.table::as.IDate("2021-12-31", format = "%Y-%m-%d")),
#                     as.numeric(data.table::as.IDate("2022-05-01", format = "%Y-%m-%d"))),
#                     labels = c("Wave_1","Wave_2","Wave_3","Wave_4"),
#                     ordered = T)]
# 
# dt[, post.VTE := ((!is.na(VTE_GP_date) &  
#                                    VTE_GP_date <= date_admitted + 90 & VTE_GP_date >= date_admitted) | 
#                                   ((!is.na(VTE_HES_date_admitted) &  
#                                       VTE_HES_date_admitted<= date_admitted + 90 & VTE_HES_date_admitted >= date_admitted))) & 
#      (!is.na(anticoagulation_prescriptions_date) &  
#         anticoagulation_prescriptions_date <= date_admitted + 90 & anticoagulation_prescriptions_date >= date_admitted)]  
# dt[, Charlson := (is.finite(pre_MI_GP) & pre_MI_GP < date_admitted) +
#         (is.finite(pre_CCF_GP) & pre_CCF_GP < date_admitted) +
#         (is.finite(pre_PVD_GP) & pre_PVD_GP < date_admitted) +
#         (is.finite(pre_Stroke_GP) & pre_Stroke_GP < date_admitted) +
#         (is.finite(pre_Dementia_GP) & pre_Dementia_GP < date_admitted) +
#         (is.finite(pre_Respiratory_GP) & pre_Respiratory_GP < date_admitted) +
#         (is.finite(pre_RA_SLE_Psoriasis_GP) & pre_RA_SLE_Psoriasis_GP < date_admitted) +
#         (is.finite(pre_Ulcer_or_bleed_GP) & pre_Ulcer_or_bleed_GP < date_admitted) +
#         (is.finite(pre_all_liver_GP) & pre_all_liver_GP< date_admitted) + 
#         (is.finite(pre_Cirrhosis_GP) & pre_Cirrhosis_GP< date_admitted)*2 + # counted in all_liver_GP too
#         (is.finite(pre_all_diabetes_GP) & pre_all_diabetes_GP< date_admitted) +
#         (is.finite(pre_Diabetic_Complications_GP) & pre_Diabetic_Complications_GP< date_admitted) + # counted in diabetes too
#         (is.finite(pre_Other_Neurology_GP) & pre_Other_Neurology_GP< date_admitted)*2 +
#         ((is.finite(pre_CKD_3_5_GP) & pre_CKD_3_5_GP< date_admitted) | (is.finite(pre_Renal_GP) & pre_Renal_GP < date_admitted))*2 +
#         (is.finite(pre_Non_Haematology_malignancy_GP) & pre_Non_Haematology_malignancy_GP< date_admitted)*2 +
#         (is.finite(pre_Haematology_malignancy_GP) & pre_Haematology_malignancy_GP< date_admitted)*2 +
#         (is.finite(pre_Metastases_GP) & pre_Metastases_GP< date_admitted)*6 +
#         (is.finite(pre_HIV_GP) & pre_HIV_GP< date_admitted)*6] 
  
library(data.table)  
load(file = here::here("output","cohort_long.RData"))
procedures <- sort(unique(dt.tv[!is.na(op.type)]$op.type))


data.table::setkey(dt.tv,patient_id,tstart,tstop)
dt.tv[,final.date := covid.end]
dt.tv[is.finite(readmit.end) & readmit.end < final.date, final.date := readmit.end]
dt.tv[is.finite(end.fu) & end.fu < final.date, final.date := end.fu]

# COVIDpositivedate minimum among end.fu. _date inserted as an event at end of row time period 

dt.tv[,event :=0]
dt.tv[COVIDpositivedate == tstop, event := 1]
dt.tv[emergency_readmitdate  == tstop & event != 1, event := 2]
dt.tv[date_death_ons == tstop & event != 1, event := 3]

data.table::setkey(dt.tv,patient_id,tstart,tstop)
dt.tv[, postop.covid.cohort := start>=0 & tstop <= final.date & end <= 90]
dt.tv[,postVTE90.perepisode := max(post.VTE & end <=90,na.rm = T), keyby = .(patient_id, end.fu)]
dt.tv[!is.finite(postVTE90.perepisode),postVTE90.perepisode := 0]

data.table::setkey(dt.tv,patient_id,tstart,tstop)
dt.tv[,postCOVID30.perepisode := max(is.finite(COVIDpositivedate) & COVIDpositivedate - admit.date >= 0 & COVIDpositivedate - admit.date <=30 ,na.rm = T), keyby = .(patient_id, end.fu)]
dt.tv[!is.finite(postCOVID30.perepisode),postCOVID30.perepisode := 0]

data.table::setkey(dt.tv,patient_id,tstart,tstop)

 n.ops <- rnd(dt.tv[(postop.covid.cohort) & start ==0 & !is.na(op.type) & is.finite(admit.date),.N])
 n.pats <- rnd(length(unique(dt.tv[(postop.covid.cohort) & start ==0 & !is.na(op.type) & is.finite(admit.date),patient_id])))
 
 start.date <- dt.tv[(postop.covid.cohort) & start ==0 & !is.na(op.type) & is.finite(admit.date), min(as.Date(as.integer(admit.date), origin = as.Date('1970-01-01')))]
 
 last.date <-  dt.tv[(postop.covid.cohort) & start ==0 & !is.na(op.type) & is.finite(admit.date), max(as.Date(as.integer(admit.date), origin = as.Date('1970-01-01')))]

```

## Study population
One third of GP practices in England use SystmOne, with records for approximately 44% of the English population. `r numbers2words(n.pats)` adult patients were identified as the study population undergoing at least one procedure whilst registered to a general practitioner using the SystmOne database at the time of the first procedure between `r format(start.date, format="%B %d %Y")` and `r format(last.date, format="%B %d %Y")`. `r stringr::str_to_sentence(numbers2words(n.ops))` procedures were identified within these patients' registration period after restricting to the first 5 procedures within each category (abdominal, cardiac, obstetric, orthopaedic,  thoracic, & vascular). The numbers and demographics of these patients and procedures are shown in Table 1.

```{r demo, results='asis', echo = F, warning=F, eval = TRUE}

demo.tab <- 
  data.table::transpose(cbind(dt.tv[(postop.covid.cohort) & start ==0 & !is.na(op.type) & final.date >= tstop,
                                 .("Procedures" = rnd(.N),
                                 "Patients" = rnd(length(unique(patient_id))),
                                 "Female" = n.perc(sex=='F',dig = 3),
                                 "Age (IQR)" = median.iqr(age,dig = 0),
                                 "BMI < 19" =  n.perc(as.numeric(bmi.cat) ==  1, dig  = 3),
                                 "BMI 19-24" =  n.perc(as.numeric(bmi.cat) ==  2, dig  = 3),
                                 "BMI 15-29" =  n.perc(as.numeric(bmi.cat) ==  3, dig  = 3),
                                 "BMI > 30" =  n.perc(as.numeric(bmi.cat) ==  4, dig  = 3),
                                 "IMD quintile 1" = n.perc(as.numeric(imd5) ==  1, dig  = 3),
                                 "IMD quintile 2" = n.perc(as.numeric(imd5) ==  2, dig  = 3),
                                 "IMD quintile 3" = n.perc(as.numeric(imd5) ==  3, dig  = 3),
                                 "IMD quintile 4" = n.perc(as.numeric(imd5) ==  4, dig  = 3),
                                 "IMD quintile 5" = n.perc(as.numeric(imd5) ==  5, dig  = 3),
                                 "Wave 1" = n.perc(wave == 'Wave_1', dig = 3),
                                 "Wave 2" = n.perc(wave == 'Wave_2', dig = 3),
                                 "Wave 3" = n.perc(wave == 'Wave_3', dig = 3),
                                 "Wave 4" = n.perc(wave == 'Wave_4', dig = 3),
                                 "1st Vaccination" = n.perc(vaccination.status.factor==1,dig = 3),
                                 "2nd Vaccination" = n.perc(vaccination.status.factor==2,dig = 3),
                                 "3rd Vaccination" = n.perc(vaccination.status.factor==3,dig = 3),
                                 "Current Cancer"  = n.perc(substr(primary_diagnosis,1,1) =='C',dig = 3),
                                 "Emergency" = n.perc(substr(admission_method,1,1) == "2",dig = 3),
                                 "Charlson index" = median.iqr(Charlson, dig = 1),
                                 "Length of stay (IQR)" =  median.iqr(discharge.date - admit.date,dig = 0),
                                 "90 day mortality (%)" =n.perc(date.90.day(x = date_death_ons, ref.dat = admit.date),dig = 4),
                                 "30 day COVID-19 (%)" = n.perc(postCOVID30.perepisode, dig = 3),
                                 "Recent COVID_19 (%)" = paste0(rnd(sum(recentCOVID, na.rm = T))," (", round(100*mean(recentCOVID != "", na.rm = T), digits = 1),"%)"),
                                 "Previous COVID_19 (%)" = paste0(rnd(sum(previousCOVID, na.rm = T))," (", round(100*mean(previousCOVID != "", na.rm = T), digits = 1),"%)"),
                                 "90 day VTE (%)" = n.perc(postVTE90.perepisode, dig = 4)), keyby = op.type], #n.perc((date.90.day(x = VTE_HES_date_admitted, ref.dat = date_admitted) |
  #                               date.90.day(x = VTE_GP_date, ref.dat = date_admitted)) &
   #                              date.90.day(x = anticoagulation_prescriptions_date, ref.dat = date_admitted),dig = 4)), keyby = op.type],
  data.table::transpose(
  cbind(
    data.table::transpose(
      data.table::dcast(
        cbind(
          dt.tv[(postop.covid.cohort) & start ==0,
                rnd(table(op.type)),
                keyby = region],
          rep(procedures,times = length(unique(dt.tv$region)))),
        V2 ~ region,
        value.var = 'V1' ),
      keep.names = "region",
      make.names = "V2")[,
                         lapply(.SD,
                                function(x) paste0(x,
                                                   ' (',
                                                   round(100*x/sum(x,na.rm = T),
                                                         digits = 1),
                                                   '%)')
                                ),
                         .SDcols = 2:7],
    sort(unique(dt.tv$region))
    ),
  make.names = "V2"),
  data.table::transpose(
  cbind(1:5,
        data.table::transpose(
          data.table::dcast(
            dt.tv[(postop.covid.cohort) & start ==0,
                  rnd(.N),
                  keyby = c('op.type','primary_diagnosis')],
            op.type ~ primary_diagnosis,
            value.var = 'V1'),
          keep.names = "Primary_Diagnosis",
          make.names = "op.type")[,1:7][,
                                        lapply(.SD,
                                               function(x) paste0(Primary_Diagnosis,
                                                                  ": ",
                                                                  x,
                                                                  ' (',
                                                                  round(100*x/sum(x,na.rm = T),
                                                                        digits = 1),
                                                                  '%)')[order(-x)]),
                                        .SDcols = 2:7][1:5,]),
  make.names = 'V1')
),
make.names = 'op.type',
keep.names = 'Characteristics')

                        
knitr::kable(demo.tab, caption = "Demographics of patients by procedure type with counts rounded to nearest 5")

```


## Post operative 90 day COVID-19 risk
Table 2 shows the cumulative risk of testing positive for COVID-19 peri-opertively for elective patients, from 7 days prior to the operation (i.e within pre operative quarantine periods for elective procedures) to 90 days post operatively. 

```{r cuminc, results='asis', echo = F, warning=FALSE, eval=T}
# load(file = here::here("output","cohort_long.RData"))
# procedures <- sort(unique(dt.tv[!is.na(op.type)]$op.type))
# 
# 
# data.table::setkey(dt.tv,patient_id,tstart,tstop)
# dt.tv[,final.date := covid.end]
# dt.tv[is.finite(readmit.end) & readmit.end < final.date, final.date := readmit.end]
# dt.tv[is.finite(end.fu) & end.fu < final.date, final.date := end.fu]

# COVIDpositivedate minimum among end.fu. _date inserted as an event at end of row time period 

#dt.tv[, postop.covid.cohort := start>=0 & tstart <= final.date & end <= 90]

covariates <- c('op.type','age.cat','sex','bmi.cat','imd5','wave',
                'vaccination.status.factor','region','Current.Cancer','Emergency','Charl12','recentCOVID','previousCOVID')

data.table::setkey(dt.tv,patient_id,tstart,tstop)

crude.covid.cov <- data.table::rbindlist(lapply(1:length(covariates), function(i) cbind(rep(covariates[i],length(levels(dt.tv[(postop.covid.cohort),as.factor(get(covariates[i]))]))),                                    levels(dt.tv[(postop.covid.cohort),as.factor(get(covariates[i]))]),
                                    cuminc.km(covariates[i], niter = 2)[,2:6])))

names(crude.covid.cov) <- c("Characteristic","Level","Number at risk",
                            "Number of events","30 day Cumulative Risk",
                            "Bootstrapped Confidence","95% interval" )

save(crude.covid.cov, file = here::here("output","bootstrap.RData"))


knitr::kable(crude.covid.cov, caption = "Demographics of patients by procedure type with counts rounded to nearest 5")

```


```{r, eval = T, echo=FALSE}
load(file = here::here("output","bootstrap.RData"))
procedures <- sort(unique(dt.tv[!is.na(op.type)]$op.type))

################################
# Post operative COVID risk ----
##################################
data.table::setkey(dt.tv,"patient_id","tstart","tstop")


post.op.covid.model <- 
  lapply(1:3, function(i) survival::coxph(survival::Surv(start,end,event==i) ~op.type + age.cat + sex + bmi.cat + imd5 + wave + vaccination.status.factor + region + Current.Cancer + Emergency + Charl12 + recentCOVID + previousCOVID, id = patient_id,
                  data = dt.tv[(postop.covid.cohort)], model = T))

n.type.events <- sort(unique(dt.tv[(postop.covid.cohort) ,event]))[-1]
cuminc.adjusted <- matrix(apply(exp(apply((log((1 - Reduce('+',lapply(n.type.events, function(i) outer(survival::basehaz(post.op.covid.model[[i]],centered = F)[,1] -
                                                         c(0,head(survival::basehaz(post.op.covid.model[[i]],centered = F)[,1],-1)),
                                                       exp(predict(object = post.op.covid.model[[i]],
                                                                   type = 'lp', 
                                                                   newdata = data.table::data.table(
                                                                    'start' = rep(0,8),
                                                                    'end' = rep(30,8*length(procedures)),
                                                                    'event' = rep(F,8*length(procedures)),
                                                                    'op.type' = rep(procedures,each = 8),
                                                                    'age.cat' = rep('(50,70]',8*length(procedures)),
                                                                    'sex' = rep('F',8*length(procedures)),
                                                                    'bmi.cat' = rep(levels(dt.tv$bmi.cat)[2],8*length(procedures)),
                                                                    'imd5' = rep(levels(dt.tv$imd5)[3], 8*length(procedures)),
                                                                    'wave' = rep(paste0('Wave_',1:4),times = 2*length(procedures)),
                                                                    'vaccination.status.factor' = rep('3',8*length(procedures)),
                                                                    'region' = rep("East Midlands",8*length(procedures)),
                                                                    'Current.Cancer' = rep(T,8*length(procedures)),
                                                                    'Emergency' =  rep(c(rep(F,4),rep(T,4)), times = length(procedures)),
                                                                    'Charl12' =  rep('Single',8*length(procedures)),
                                                                    'recentCOVID' = rep(F,8*length(procedures)),
                                                                    'previousCOVID' = rep(F,8*length(procedures)),
                                                                    'patient_id' = 1:(8*length(procedures))))),'*')))))),
                 2,cumsum))*
        outer(survival::basehaz(post.op.covid.model[[1]],centered = F)[,1] -
                                                         c(0,head(survival::basehaz(post.op.covid.model[[1]],centered = F)[,1],-1)),
         exp(predict(object = post.op.covid.model[[1]],
                                                                   type = 'lp', 
                                                                   newdata = data.table::data.table(
                                                                    'start' = rep(0,8),
                                                                    'end' = rep(30,8*length(procedures)),
                                                                    'event' = rep(F,8*length(procedures)),
                                                                    'op.type' = rep(procedures,each = 8),
                                                                    'age.cat' = rep('(50,70]',8*length(procedures)),
                                                                    'sex' = rep('F',8*length(procedures)),
                                                                    'bmi.cat' = rep(levels(dt.tv$bmi.cat)[2],8*length(procedures)),
                                                                    'imd5' = rep(levels(dt.tv$imd5)[3], 8*length(procedures)),
                                                                    'wave' = rep(paste0('Wave_',1:4),times = 2*length(procedures)),
                                                                    'vaccination.status.factor' = rep('3',8*length(procedures)),
                                                                    'region' = rep("East Midlands",8*length(procedures)),
                                                                    'Current.Cancer' = rep(T,8*length(procedures)),
                                                                    'Emergency' =  rep(c(rep(F,4),rep(T,4)), times = length(procedures)),
                                                                    'Charl12' =  rep('Single',8*length(procedures)),
                                                                    'recentCOVID' = rep(F,8*length(procedures)),
                                                                    'previousCOVID' = rep(F,8*length(procedures)),
                                                                    'patient_id' = 1:(8*length(procedures)))))),
      2,cumsum)[30,], byrow = T, ncol = 4)
  #data.table::fwrite(broom::tidy(post.op.covid.model[[1]], exponentiate= T, conf.int = T), file = here::here("output","post_op_covid_model.csv"))
rownames(cuminc.adjusted) <- c(paste0(rep(procedures,each = 2), 
                                    rep(c(F,T), times = length(procedures))))
knitr::kable(cuminc.adjusted,col.names = paste0("Wave ",1:4), row.names = T)
```

