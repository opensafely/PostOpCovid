---
title: "Results"
author: "Colin Crooks"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_caption: true
---




```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#library(doParallel)
#ncores <- parallel::detectCores(logical = T)
#cl <- makeCluster(ncores)
#registerDoParallel(cl)
###########################################################
#https://github.com/ateucher/useful_code/blob/master/R/numbers2words.r
#https://gist.github.com/psychemedia/numbers2words.R
numbers2words <- function(x){
  ## Function by John Fox found here: 
  ## http://tolstoy.newcastle.edu.au/R/help/05/04/2715.html
  ## Tweaks by AJH to add commas and "and"
  helper <- function(x){
    
    digits <- rev(strsplit(as.character(x), "")[[1]])
    nDigits <- length(digits)
    if (nDigits == 1) as.vector(ones[digits])
    else if (nDigits == 2)
      if (x <= 19) as.vector(teens[digits[1]])
    else trim(paste(tens[digits[2]],
                    Recall(as.numeric(digits[1]))))
    else if (nDigits == 3) trim(paste(ones[digits[3]], "hundred and", 
                                      Recall(makeNumber(digits[2:1]))))
    else {
      nSuffix <- ((nDigits + 2) %/% 3) - 1
      if (nSuffix > length(suffixes)) stop(paste(x, "is too large!"))
      trim(paste(Recall(makeNumber(digits[
        nDigits:(3*nSuffix + 1)])),
        suffixes[nSuffix],"," ,
        Recall(makeNumber(digits[(3*nSuffix):1]))))
    }
  }
  trim <- function(text){
    #Tidy leading/trailing whitespace, space before comma
    text=gsub("^\ ", "", gsub("\ *$", "", gsub("\ ,",",",text)))
    #Clear any trailing " and"
    text=gsub(" and$","",text)
    #Clear any trailing comma
    gsub("\ *,$","",text)
  }  
  makeNumber <- function(...) as.numeric(paste(..., collapse=""))     
  #Disable scientific notation
  opts <- options(scipen=100) 
  on.exit(options(opts)) 
  ones <- c("", "one", "two", "three", "four", "five", "six", "seven",
            "eight", "nine") 
  names(ones) <- 0:9 
  teens <- c("ten", "eleven", "twelve", "thirteen", "fourteen", "fifteen",
             "sixteen", " seventeen", "eighteen", "nineteen")
  names(teens) <- 0:9 
  tens <- c("twenty", "thirty", "forty", "fifty", "sixty", "seventy", "eighty",
            "ninety") 
  names(tens) <- 2:9 
  x <- round(x)
  suffixes <- c("thousand", "million", "billion", "trillion")     
  if (length(x) > 1) return(trim(sapply(x, helper)))
  helper(x)
  }
  
  rnd <- function(x) floor(x/5)*5
  
  median.iqr <- function(x, dig=0) paste0(round(median(x, na.rm = T))," (",paste(round(quantile(x,c(0.25,0.75),na.rm = T),digits = dig),collapse = ","),")")
  
  n.perc <- function(x, dig=0) paste0(rnd(sum(x == T, na.rm = T))," (",round(mean(x,na.rm = T),digits = dig)*100,"%)")
  
  date.90.day <- function(x,ref.dat) is.finite(x) & as.numeric(x) - as.numeric(ref.dat) <= 90  & as.numeric(x) - as.numeric(ref.dat) >=0
  
  safelog <- function(x) { x[x < 1e-200] <- 1e-200; log(x) }
  
  cuminc.km <- function(x,niter)  { 
    safelog <- function(x) { x[x < 1e-200] <- 1e-200; log(x) }
    n.type.events <- sort(unique(dt.tv[(postop.covid.cohort),event]))[-1]
    data.table::setkey(dt.tv, patient_id, tstart,tstop)
    est <- boot.est <- Reduce(merge,lapply(n.type.events, function(i) data.table::setDT(summary(survival::survfit(survival::Surv(start,end,event==i) ~ get(x), 
                                                                                 data = dt.tv[(postop.covid.cohort)], 
                                                                                 id = patient_id),
                                                               times = sort(unique(dt.tv[(postop.covid.cohort) & event == i,end]))
    )[c('strata','time','n.risk', 'n.event')])[,(paste0('haz',i)) := n.event/n.risk][,c(1,2,5)])
    )[order(strata,time),
      .(time,cumsum(exp(cumsum(log(1 - Reduce('+',.SD))))*haz1)),
      keyby = strata, 
      .SDcols = paste0('haz',n.type.events)][order(strata,time),
                                   round(tail(V2,1),digits = 3)*100, 
                                   keyby = strata] 
  
#  boot.est<- foreach::foreach(iter = 1:niter, .combine = 'cbind',.multicombine = T,.export = 'dt.tv',.packages = 'data.table') %dopar% {

  for(iter in 1:niter) {
    samp.patient_id <- dt.tv[patient_id %in% sort(sample(unique(dt.tv[(postop.covid.cohort),patient_id]), replace = T))]
    data.table::setkey(dt.tv, patient_id, tstart,tstop)
     boot.est <- cbind(boot.est,Reduce(merge,lapply(n.type.events,
                                    function(i) {
       event.times = sort(unique(dt.tv[(postop.covid.cohort) & event == i,end]))
       if(samp.patient_id[(event==i),.N] > 0) {
          data.table::setDT(summary(survival::survfit(survival::Surv(start,end,event==i) ~ get(x), 
      data = samp.patient_id,
      id = patient_id),
      times = event.times,
      extend = T)[c('strata','time','n.risk', 'n.event')])[
        , (paste0('haz',i)) := n.event/n.risk][,c(1,2,5)]
       }
       else {
        data.table::data.table('strata' = rep(levels(est[[1]]), 
                                              each = length(event.times)),
                               'time' = rep(event.times, 
                                            times = length(levels(est[[1]]))))[,(paste0('haz',i)) := 0] 
       }
     }
    )
)[order(strata,time),.(time,
                       cumsum(exp(cumsum(safelog(1 - Reduce('+',.SD))))*haz1)),
  keyby = strata, 
  .SDcols = paste0('haz',n.type.events)][order(strata,time),
                                         round(tail(V2,1),digits = 3)*100,
                                         keyby = strata][,2])
}
  return(cbind(est[,1],
               rnd(dt.tv[(postop.covid.cohort) & tstop == final.date,.N, keyby = get(x)][,2]),
               rnd(data.table::setDT(summary(survival::survfit(survival::Surv(start,end,event==1) ~ get(x), 
                   data = dt.tv[(postop.covid.cohort),],
                   id = patient_id), times = 90)[c('n.event')])),
               est[,2],
               t(apply(boot.est[,2:(iter + 1)],1,quantile,c(0.025,0.975), na.rm = T))))
  }

##########################################################


#########################
# Basic counts and descriptions from raw data
#############################
index_date <- data.table::as.IDate("2020-02-01")
dt <- data.table::fread(here::here("output", "input.csv"))

procedures <- c('Abdominal','Cardiac','Obstetrics','Orthopaedic','Thoracic', 'Vascular')
procs <- paste0(rep(procedures,each = 5),"_",1:5)

dt[,dateofbirth := (data.table::as.IDate(paste0(dob,'-15')))]
dt[dereg_date != "",gp.end := data.table::as.IDate(paste0(dereg_date,'-15'))]
dt[, imd := as.numeric(imd)]
dt[, imd5 := cut(imd, breaks = seq(0,33000,33000/5),  include.lowest = T, ordered_result = F)]

####################################################################
# Multiple operations per row. Reshape to long format
####################################################################


####### Reshape repeated procedures within a specialty
repeated.vars <- names(dt)[grepl(pattern = paste(procedures,collapse = '|'),x = names(dt))]
non.op.vars <- names(dt)[!grepl(pattern = paste(procedures,collapse = '|'),x = names(dt))]

aggregate_operations <- data.table::melt(dt, id.var = 'patient_id',
                     measure = patterns(as.vector(outer(paste0(procedures,'_[0-9]'),
                unique(gsub(pattern = paste0(as.vector(outer(procedures,paste0("_",1:5),paste0)),collapse = "|"),replacement = "",x = paste0(repeated.vars,'$'))),
                paste0))),
                variable.name = 'op.number',
                value.name = as.vector(outer(procedures,unique(gsub(pattern = paste0(as.vector(outer(procedures,paste0("_",1:5),paste0)),collapse = "|"),replacement = "",x = repeated.vars)),paste0)))[order(patient_id,op.number)]



####### Reshape repeated procedures within a specialty
repeated.vars <- names(aggregate_operations)[grepl(pattern = paste(procedures,collapse = '|'),x = names(aggregate_operations))]

aggregate_operations <- data.table::melt(aggregate_operations, id.var = 'patient_id',
                                         measure = patterns(as.vector(outer(paste0('(',paste0(procedures, collapse = '|'),')_'),
                                                                            unique(gsub(pattern = paste0(paste0(procedures,"_"),collapse = "|"),replacement = "",x = paste0(repeated.vars,'$'))),
                                                                            paste0))),
                                         variable.name = 'op.type', 
                                         variable.factor = T,
                                         value.name = unique(gsub(pattern = paste0(paste0(procedures,"_"),collapse = "|"),replacement = "",x = repeated.vars)))[order(patient_id,date_admitted, op.type)]

aggregate_operations[,op.type := factor(op.type, levels = 1:6, labels = procedures)]

dt <- dt[,non.op.vars, with = F][aggregate_operations, on = "patient_id"]
rm(aggregate_operations)


dt[, keep := F]
dt[!is.na(dereg_date), dereg_date := data.table::as.IDate(paste0(dereg_date,"-30"), format = "%Y-%m-%d")]
dt[!is.na(date_admitted) &  (is.na(dereg_date) | as.numeric(date_admitted) <= dereg_date), keep := T] 
dt <- dt[keep == T,]

n.ops <- rnd(dt[is.finite(date_admitted),.N])
n.pats <- rnd(sum(length(unique(dt[,patient_id]))))
start.date <- dt[, min(date_admitted)]

last.date <-  dt[, max(date_admitted)]

dt[,admit.wave := cut(as.numeric(date_admitted),
                breaks =
                  c(as.numeric(data.table::as.IDate("2020-01-01", format = "%Y-%m-%d")), 
                    as.numeric(data.table::as.IDate("2020-09-01", format = "%Y-%m-%d")),                                       
                    as.numeric(data.table::as.IDate("2021-05-01", format = "%Y-%m-%d")),
                    as.numeric(data.table::as.IDate("2021-12-31", format = "%Y-%m-%d")),
                    as.numeric(data.table::as.IDate("2022-05-01", format = "%Y-%m-%d"))),
                    labels = c("Wave_1","Wave_2","Wave_3","Wave_4"),
                    ordered = T)]

dt[, post.VTE := ((!is.na(VTE_GP_date) &  
                                   VTE_GP_date <= date_admitted + 90 & VTE_GP_date >= date_admitted) | 
                                  ((!is.na(VTE_HES_date_admitted) &  
                                      VTE_HES_date_admitted<= date_admitted + 90 & VTE_HES_date_admitted >= date_admitted))) & 
     (!is.na(anticoagulation_prescriptions_date) &  
        anticoagulation_prescriptions_date <= date_admitted + 90 & anticoagulation_prescriptions_date >= date_admitted)]  

```

## Study population
One third of GP practices in England use SystmOne, with records for approximately 44% of the English population. In this study `r numbers2words(n.pats)` adult patients were identified undergoing at least one procedure whilst registered to a general practitioner using the SystmOne database at the time of the first procedure between `r format(start.date, format="%B %d %Y")` and `r format(last.date, format="%B %d %Y")`. `r stringr::str_to_sentence(numbers2words(n.ops))` procedures were identified within thse patients' registration period after restricting to the first 5 procedures within each category (abdominal, cardiac, obstetric, orthopaedic,  thoracic, & Vascular). The numbers and demographics of these patients and procedures are shown in Table 1.

```{r demo, results='asis', echo = F, warning=F}

dt[bmi == 0, bmi := NA]
demo.tab <- 
  data.table::transpose(cbind(dt[ ,.("Procedures" = rnd(.N),
                                 "Patients" = rnd(length(unique(patient_id))),
                                 "Female" = n.perc(sex=='F',dig = 3),
                                 "Age (IQR)" = median.iqr((as.numeric(date_admitted) - as.numeric(dateofbirth))/365.25,dig = 0),
                                 "BMI (IQR)" =  median.iqr(bmi,dig = 0),
                                 "IMD quintile (IQR)" = median.iqr(as.numeric(imd5),dig = 0),
                                 "1st Vaccination" = n.perc(is.finite(covid_vaccine_dates_1) & date_admitted  - covid_vaccine_dates_1 >= 14,dig = 3),
                                 "2nd Vaccination" = n.perc(is.finite(covid_vaccine_dates_2) & date_admitted  - covid_vaccine_dates_2 >= 14,dig = 3),
                                 "3rd Vaccination" = n.perc(is.finite(covid_vaccine_dates_3) & date_admitted - covid_vaccine_dates_3 >= 14,dig = 3),
                                 "Current Cancer"  = n.perc(substr(primary_diagnosis,1,1) =='C',dig = 3),
                                 "Emergency" = n.perc(substr(admission_method,1,1) == "2",dig = 3),
                                 "Length of stay (IQR)" =  median.iqr(date_discharged - date_admitted,dig = 0),
                                 "90 day mortality (%)" =n.perc(date.90.day(x = date_death_ons, ref.dat = date_admitted),dig = 4),
                                 "90 day COVID-19 (%)" = paste0(rnd(sum(case_category != "", na.rm = T))," (", round(100*mean(case_category != "", na.rm = T), digits = 1),"%)"),
                                 "90 day VTE (%)" = n.perc((date.90.day(x = VTE_HES_date_admitted, ref.dat = date_admitted) |
                                 date.90.day(x = VTE_GP_date, ref.dat = date_admitted)) &
                                 date.90.day(x = anticoagulation_prescriptions_date, ref.dat = date_admitted),dig = 4)), keyby = op.type],
  data.table::transpose(
  cbind(
    data.table::transpose(
      data.table::dcast(
        cbind(
          dt[,
                rnd(table(op.type)),
                keyby = region],
          rep(procedures,times = 10)),
        V2 ~ region,
        value.var = 'V1' ),
      keep.names = "region",
      make.names = "V2")[,
                         lapply(.SD,
                                function(x) paste0(x,
                                                   ' (',
                                                   round(100*x/sum(x,na.rm = T),
                                                         digits = 1),
                                                   '%)')
                                ),
                         .SDcols = 2:7],
    sort(unique(dt$region))
    ),
  make.names = "V2"),
  data.table::transpose(
  cbind(1:5,
        data.table::transpose(
          data.table::dcast(
            dt[,
                  rnd(.N),
                  keyby = c('op.type','primary_diagnosis')],
            op.type ~ primary_diagnosis,
            value.var = 'V1'),
          keep.names = "Primary_Diagnosis",
          make.names = "op.type")[,1:7][,
                                        lapply(.SD,
                                               function(x) paste0(Primary_Diagnosis,
                                                                  ": ",
                                                                  x,
                                                                  ' (',
                                                                  round(100*x/sum(x,na.rm = T),
                                                                        digits = 1),
                                                                  '%)')[order(-x)]),
                                        .SDcols = 2:7][1:5,]),
  make.names = 'V1')
),
make.names = 'op.type',
keep.names = 'Characteristics')

                        
knitr::kable(demo.tab, caption = "Demographics of patients by procedure type with counts rounded to nearest 5")

```


## Post operative 90 day COVID-19 risk
Table 2 shows the cumulative risk of testing positive for COVID-19 peri-opertively for elective patients, from 7 days prior to the operation (i.e within pre operative quarantine periods for elective procedures) to 90 days post operatively. 

```{r cuminc, results='asis', echo = F, warning=FALSE, eval=T}
load(file = here::here("output","cohort_long.RData"))
procedures <- unique(dt.tv$op.type)


data.table::setkey(dt.tv,patient_id,tstart,tstop)
dt.tv[,final.date := covid.end]
dt.tv[is.finite(readmit.end) & readmit.end < final.date, final.date := readmit.end]
dt.tv[is.finite(end.fu) & end.fu < final.date, final.date := end.fu]

dt.tv[,event :=0]
dt.tv[COVIDpositive == T, event := 1]
dt.tv[emergency_readmit == T & COVIDpositive !=T, event := 2]
dt.tv[died == T & COVIDpositive !=T, event := 3]

dt.tv[, postop.covid.cohort := start>=0 & tstop <= final.date & end <= 90]


covariates <- c('age.cat','sex','op.type','Charl12','bmi.cat','imd5','region',
                'vaccination.status.factor','Emergency','Current.Cancer','wave')

data.table::setkey(dt.tv,patient_id,tstart,tstop)

crude.covid.cov <- data.table::rbindlist(lapply(1:length(covariates), function(i) cbind(rep(covariates[i],length(levels(dt.tv[(postop.covid.cohort),as.factor(get(covariates[i]))]))),
                                    levels(dt.tv[(postop.covid.cohort),as.factor(get(covariates[i]))]),
                                    cuminc.km(covariates[i], niter = 1000)[,2:6])))

names(crude.covid.cov) <- c("Characteristic","Level","Number at risk",
                            "Number of events","90 day Cumulative Risk",
                            "Bootstrapped Confidence","95% interval" )

save(crude.covid.cov, file = here::here("output","bootstrap.RData"))

knitr::kable(crude.covid.cov, caption = "Demographics of patients by procedure type with counts rounded to nearest 5")

```