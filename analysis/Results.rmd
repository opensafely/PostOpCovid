---
title: "Results"
author: "Colin Crooks"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    toc_float: true
    fig_caption: true
---

# Methods



```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = F, warning = F)
library(foreach)
library(data.table)
library(kableExtra)
ncores <- parallel::detectCores(logical = T) - 1
data.table::setDTthreads(ncores)
max.category <- function(predi) {unique(dt.tv[!is.na(get(covariates[predi])),get(covariates[predi])], na.rm = T)[which.max(dt.tv[!is.na(get(covariates[predi])),.N, by = c(covariates[predi])][['N']])]}

source(here::here("analysis","Utils.R"))

dt.tv <- data.table::setDT(feather::read_feather(here::here("output","cohort_long.feather")))
procedures <- c('Abdominal','Cardiac','Obstetrics','Orthopaedic','Thoracic', 'Vascular')
covariates <- c(procedures,'age.cat','sex','bmi.cat','imd5','wave',
                'vaccination.status.factor','region','Current.Cancer','Emergency','Charl12','recentCOVID','previousCOVID')


## Count variables for demographic tables
dt.tv[,postVTE90.perepisode := max(post.VTE & end <=90,na.rm = T), keyby = .(patient_id, end.fu)]
dt.tv[!is.finite(postVTE90.perepisode),postVTE90.perepisode := 0]

data.table::setkey(dt.tv,patient_id,tstart,tstop)
dt.tv[ ,postCOVID30.perepisode := event == 1 & end <=30]

dt.tv[,postCOVID30.perepisode := max(postCOVID30.perepisode,na.rm = T), keyby = .(patient_id, end.fu)]
dt.tv[!is.finite(postCOVID30.perepisode),postCOVID30.perepisode := 0]

data.table::setkey(dt.tv,patient_id,tstart,tstop)

 n.ops <- rnd(dt.tv[ start ==0  & is.finite(admit.date) & any.op == T,lapply(.SD,function(x) sum(x == T)), .SDcols = c(procedures)])
 
 n.pats <- rnd(length(unique(dt.tv[ start ==0 & is.finite(admit.date) & any.op == T,patient_id])))
 
 start.date <- dt.tv[(postop.covid.cohort) & start ==0 & is.finite(admit.date) & any.op == T, min(as.Date(as.integer(admit.date), origin = as.Date('1970-01-01')))]
 
 last.date <-  dt.tv[(postop.covid.cohort) & start ==0  & is.finite(admit.date) & any.op == T, max(as.Date(as.integer(admit.date), origin = as.Date('1970-01-01')))]

```

## Study population
One third of GP practices in England use SystmOne, with records for approximately 44% of the English population. `r paste(n.pats)` adult patients were identified as the study population undergoing at least one procedure whilst registered to a general practitioner using the SystmOne database at the time of the first procedure between `r format(start.date, format="%B %d %Y")` and `r format(last.date, format="%B %d %Y")`. The flow chart shows the procedures identified within these patients' registration period after restricting to the first 5 procedures within each category (abdominal, cardiac, obstetric, orthopaedic,  thoracic, & vascular), and the numbers of outcomes after adjusting for censoring by competing risks.  The numbers and demographics of these patients and procedures are shown in Table 1.

```{r flowchart, fig.dim = c(6, 8),fig.align = "center",fig.cap = c("Flow chart of patients, procedures and outcomes included within censored follow up time")}
load(here::here("output","flowchart.RData"))
#knitr::include_graphics(path = here::here("output","Flowchart.pdf"))
p
```

```{r demo, results='asis', echo = F, warning=F, eval = TRUE}
load(here::here("output","table_demo.RData"))

 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
 knitr::kable(demo.tab, caption = "Demographics of patients by procedure type with counts rounded to nearest 10, columns not mutually exclusive")
 )

```


## Post operative 90 day COVID-19 risk
The cumulative risk of testing positive for COVID-19 peri-opertively, from the operation to 30 days post operatively were calculated in table 2. The adjusted estimates were calculated from the Cox survival models fitted separately for COVID-19, mortality and emergency non covid admission.

```{r postopcovid, eval = T, echo=FALSE}

################################
# Post operative COVID risk model----
##################################
load(here::here("output","postopcovid_crude.RData"))
load(here::here("output","postopcovid_adjusted.RData"))

#knitr::kable(broom::tidy(post.op.covid.model[[1]], exponentiate= T, conf.int = T),digits = 2)

comb_postop_covid <- cbind(crude.covid.cov,adjusted.cuminc)

names(comb_postop_covid) <- c("Characteristic","Level","Number at risk",
                            "Number of events","30 day Cumulative Risk adjusted for censoring","30 day Cumulative Risk adjusted for death and emergency readmission","30 day Cumulative Risk adjusted for all covariates")

 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(comb_postop_covid, 
             caption = paste0("Cumulative incidence of 30 day post operative COVID of patients by procedure type with counts rounded to nearest 10. Adjusted predictions set for 50 year old female with a single morbidity with a bmi of 20, for an elective abdominal cancer operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation")
             #at their most frequent population values:\n procedure = ", procedures[which.max(dt.tv[,lapply(.SD,sum,na.rm = T), .SDcols = c(procedures)])], Reduce(lapply(which(covariates == 'age.cat'):which(covariates == 'previousCOVID'), function(i) paste0(covariates[i] ,' = ',max.category(which(covariates == covariates[i])))), f =function(x,y) paste(x,y, collapse = ", ")))
             )
)
```
#### Selected procedures
```{r postopcovid_sub, eval = T, echo=FALSE}

################################
# Post operative COVID risk model----
##################################
load(here::here("output","postopcovid_crude_sub.RData"))
load(here::here("output","postopcovid_adjusted_sub.RData"))

#knitr::kable(broom::tidy(post.op.covid.model[[1]], exponentiate= T, conf.int = T),digits = 2)

comb_postop_covid.sub <- cbind(crude.covid.cov.sub,adjusted.cuminc.sub)

names(comb_postop_covid.sub) <- c("Characteristic","Level","Number at risk",
                            "Number of events","30 day Cumulative Risk adjusted for censoring","30 day Cumulative Risk adjusted for death and emergency readmission","30 day Cumulative Risk adjusted for all covariates")
 
 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(comb_postop_covid.sub, 
             caption = paste0("Cumulative incidence of 30 day post operative COVID of patients by procedure type with counts rounded to nearest 10. Adjusted predictions set for 50 year old female with a single morbidity with a bmi of 20, for an elective abdominal cancer operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation")
             #at their most frequent population values:\n procedure = ", procedures[which.max(dt.tv[,lapply(.SD,sum,na.rm = T), .SDcols = c(procedures)])], Reduce(lapply(which(covariates == 'age.cat'):which(covariates == 'previousCOVID'), function(i) paste0(covariates[i] ,' = ',max.category(which(covariates == covariates[i])))), f =function(x,y) paste(x,y, collapse = ", ")))
             )
)
```



### Post operative COVID-19 risk by COVID-19 waves and operation category
The  adjusted cumulative risk estimates were calculated for each COVID-19 wave stratified by operation category in table 3.

```{r postopcovid_waves}

 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.waves,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 30 day post operative COVID of patients by procedure type stratified by COVID-19 wave."), row.names = T, digits = 2)
 )
```

#### Selected procedures
```{r postopcovid_waves_sub}

 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.waves.sub,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 30 day post operative COVID of patients by selected procedures type stratified by COVID-19 wave."), row.names = T, digits = 2)
 )
```

### Post operative COVID-19 risk by weekly post discharge period
The adjusted cumulative risk for COVID-19 were calculated for an inpatient week prior to discharge and for each of the 4 weeks post discharge in figure 1. This showed the risk peaked in the couple of weeks after discharge before falling again.
```{r postopcovid_tv}
load(file = here::here("output","postopcovid_tv.RData"))

ggplot2::ggplot(weekly.post.op.risk) + 
  ggplot2::geom_col(ggplot2::aes(x = factor(`Risk period`, level = c("Week pre discharge","1st week","2nd week","3rd week","4th week")), 
                                                                      y = Risk)) +
ggplot2::xlab("Risk Period post discharge") + 
  ggplot2::ylab("Cumulative risk during time period") + ggplot2::ggtitle("Post operative risk of COVID-19 over time",
                                                                         subtitle = "Adjusted for age, sex, SES, BMI, co-morbidity, vaccination,\n operation category, emergency, previous COVID-19, \n COVID_19 wave, and competing risks of death and readmission")

```   

#### Selected procedures
```{r postopcovid_tv_sub}
load(file = here::here("output","postopcovid_tv_sub.RData"))

ggplot2::ggplot(weekly.post.op.risk.sub) + 
  ggplot2::geom_col(ggplot2::aes(x = factor(`Risk period`, level = c("Week pre discharge","1st week","2nd week","3rd week","4th week")), 
                                                                      y = Risk)) +
ggplot2::xlab("Risk Period post discharge") + 
  ggplot2::ylab("Cumulative risk during time period") + ggplot2::ggtitle("Post operative risk of COVID-19 over time",
                                                                         subtitle = "Adjusted for age, sex, SES, BMI, co-morbidity, vaccination,\n operation category, emergency, previous COVID-19, \n COVID_19 wave, and competing risks of death and readmission")

```

## COVID impact on post operative length of stay
An accelerated failure survival model was fitted to directly estimate the effect of post operative COVID-19 on post operative length of stay 
```{r postopLOS}

load(file = here::here("output","postoplos.RData"))

#knitr::kable(broom::tidy(post.op.LOS.model, exponentiate= T, conf.int = T),digits = 2)
 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(mean.adjusted.los,col.names = paste0("Wave ",1:4),caption = paste0("Predicted mean length of stay for patients by procedure type and COVID-19 infection, stratified by COVID-19 wave."), row.names = T, digits = 2)
)
```
#### Selected procedures
```{r postopLOS_sub}

load(file = here::here("output","postoplos_sub.RData"))

#knitr::kable(broom::tidy(post.op.LOS.model, exponentiate= T, conf.int = T),digits = 2)

 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(mean.adjusted.los.sub,col.names = paste0("Wave ",1:4),caption = paste0("Predicted mean length of stay for patients by procedure type and COVID-19 infection, stratified by COVID-19 wave."), row.names = T, digits = 2)
 )
```

## Post operative VTE risk

```{r postopVTE, results='asis'}
load(file = here::here("output","postopVTE.RData"))

#knitr::kable(broom::tidy(post.op.VTE.model[[1]], exponentiate= T, conf.int = T),digits = 2)


 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.VTE,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative VTE risk by procedure type and COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )

```

```{r postopcovid_VTE_tv}

ggplot2::ggplot(weekly.post.op.VTE.risk) + 
  ggplot2::geom_col(ggplot2::aes(x = factor(`Risk period`, level = c("Week pre discharge","1st week","2nd week","3rd week","4th week")), 
                                                                      y = Risk, 
                                 group = COVID, 
                                 colour = COVID,
                                 fill = COVID), position = "dodge") +
ggplot2::xlab("Risk Period post discharge") + 
  ggplot2::ylab("Cumulative risk during time period") + ggplot2::ggtitle("Post operative risk of VTE over time stratified by COVID-19 infection",
                                                                         subtitle = "Adjusted for age, sex, SES, BMI, co-morbidity, vaccination,\n operation category, emergency, previous COVID-19, \n COVID_19 wave, and competing risks of death and readmission")

``` 

#### Selected procedures 
```{r postopVTE_sub, results='asis'}
load(file = here::here("output","postopVTE_sub.RData"))

#knitr::kable(broom::tidy(post.op.VTE.model[[1]], exponentiate= T, conf.int = T),digits = 2)


 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.VTE.sub,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative VTE risk by procedure type and COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )

```

```{r postopcovid_VTE_tv_sub}

ggplot2::ggplot(weekly.post.op.VTE.risk.sub) + 
  ggplot2::geom_col(ggplot2::aes(x = factor(`Risk period`, level = c("Week pre discharge","1st week","2nd week","3rd week","4th week")), 
                                                                      y = Risk, 
                                 group = COVID, 
                                 colour = COVID,
                                 fill = COVID), position = "dodge") +
ggplot2::xlab("Risk Period post discharge") + 
  ggplot2::ylab("Cumulative risk during time period") + ggplot2::ggtitle("Post operative risk of VTE over time stratified by COVID-19 infection",
                                                                         subtitle = "Adjusted for age, sex, SES, BMI, co-morbidity, vaccination,\n operation category, emergency, previous COVID-19, \n COVID_19 wave, and competing risks of death and readmission")

``` 

## COVID impact on post operative Mortality

```{r postopmortality}
load(file = here::here("output","postopmortality.RData"))

#knitr::kable(broom::tidy(post.op.died.model[[1]], exponentiate= T, conf.int = T),digits = 2)


 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.mortality,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative mortality risk by procedure type and COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )
```

#### Selected procedures


```{r postopmortality_sub}
load(file = here::here("output","postopmortality_sub.RData"))

#knitr::kable(broom::tidy(post.op.died.model[[1]], exponentiate= T, conf.int = T),digits = 2)


 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.mortality.sub,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative mortality risk by procedure type and COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )
```

# COVID impact on Emergency Readmission

```{r postopreadmit}
load(file = here::here("output","postopreadmit.RData"))

 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.readmit,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative emergency non covid readmission risk by procedure type and COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )
```

#### Selected procedures


```{r postopreadmit_sub}
load(file = here::here("output","postopreadmit_sub.RData"))

 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.readmit.sub,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative emergency non covid readmission risk by selected procedure type and COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )
```