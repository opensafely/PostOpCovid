---
title: "Report"
author: "Colin Crooks"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    toc: true
    fig_caption: true
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

# Loading libraries as some sub functions fail within Knitr. However function space is specified where possible to avoid confusion in scripts
library(foreach)
library(data.table)
library(kableExtra)
library(survival)
library(modelsummary)

# This alters kableExtra function to print black text in tables when Rstudio is in dark mode
print.kableExtra <- function (x, ...) {
  view_html <- getOption("kableExtra_view_html", TRUE)
  if (view_html & interactive()) {
    dep <- list(
      rmarkdown::html_dependency_jquery(), 
      rmarkdown::html_dependency_bootstrap(theme = "cosmo"), 
      kableExtra::html_dependency_kePrint(), 
      kableExtra::html_dependency_lightable()
    )
    
    x <- sub('style="', 'style="color: black; ', as.character(x), fixed = TRUE)
        
    html_kable <- htmltools::browsable(
      htmltools::HTML(
        as.character(x), 
        "<script type=\"text/x-mathjax-config\">MathJax.Hub.Config({tex2jax: {inlineMath: [[\"$\",\"$\"]]}})</script><script async src=\"https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML\"></script>"
      )
    )
    htmltools::htmlDependencies(html_kable) <- dep
    class(html_kable) <- "shiny.tag.list"
    print(html_kable)
  }
  else {
    cat(as.character(x))
  }
}

ncores <- parallel::detectCores(logical = T) - 1
data.table::setDTthreads(ncores)
max.category <- function(predi) {unique(dt.tv[!is.na(get(covariates[predi])),get(covariates[predi])], na.rm = T)[which.max(dt.tv[!is.na(get(covariates[predi])),.N, by = c(covariates[predi])][['N']])]}

source(here::here("analysis","Utils.R"))

dt.tv <- data.table::setDT(arrow::read_feather(here::here("output","cohort_long.feather")))
procedures <- c('Abdominal','Cardiac','Obstetrics','Orthopaedic','Thoracic', 'Vascular')
covariates <- c(procedures,'age.cat','sex','bmi.cat','imd5','wave',
                'vaccination.status.factor','region','Current.Cancer','Emergency','Charl12','recentCOVID','previousCOVID')


## Count variables for demographic tables in respective R files for demo table and flowchart

data.table::setkey(dt.tv,patient_id,tstart,tstop)

data.table::setkey(dt.tv,patient_id,tstart,tstop)

 n.ops <- rnd(dt.tv[ start ==0  & is.finite(admit.date) & any.op == T,lapply(.SD,function(x) sum(x == T)), .SDcols = c(procedures)])
 
 n.pats <- rnd(length(unique(dt.tv[ start ==0 & is.finite(admit.date) & any.op == T,patient_id])))
 
 start.date <- dt.tv[(postop.covid.cohort) & start ==0 & is.finite(admit.date) & any.op == T, min(as.Date(as.integer(admit.date), origin = as.Date('1970-01-01')))]
 
 last.date <-  dt.tv[(postop.covid.cohort) & start ==0  & is.finite(admit.date) & any.op == T, max(as.Date(as.integer(admit.date), origin = as.Date('1970-01-01')))]

```

# Background

## Post operative COVID-19 risk
People need to attend hospital for investigations and procedures to diagnose and treat illnesses. However, early evidence in the pandemic suggested that there was a significant risk and impact of acquiring COVID-19 on outcomes(1,2). There is evidence that fear of COVID-19 kept them away in the pandemic (3–5). As part of the health system recovery patients need to know whether they can come to hospital safely, doctors need to understand the risk and impact of acquiring COVID-19, and doctors also need to understand the patient and procedure factors predicting associated outcomes. Only then can they implement safe policies and inform patients the risks and benefits of attending hospital for their routine care. 

## VTE
VTE risk is elevated following surgery. During the COVID pandemic an association between COVID infection and increased risk of VTE has been described in all patients and in those having surgery. The COVIDSURG collaborative reported an overall rate of post-operative VTE of 0.6% (742/128013). The rate was 0.5% (666/123,591) in patients without SARS-CoV-2; 2.2% (50/2317) in patients with peri-operative SARS-CoV-2; 1.6% (15/953) in patients with recent SARS-CoV-2; and 1.0% (11/1148) in patients with previous SARS-CoV-2. This represented a 2 fold increased risk of VTE in those with peri-operative COVID infection. VTE was independently associated with an increase in risk of mortality at 30 days. This study was only able to divide patients by major/minor surgery and so was not able to describe risk by type of surgery to help inform guidelines. They also only reported on rates to 30 days and prior work has demonstrated the risk of VTE extends beyond this period.

Within our hospital we use routinely collected data to measure these risks and monitor the impacts of policy changes(6). Data in a single trust however cannot provide the power to fully characterise the risks pertaining to different patients and procedures. Previous work is often not applicable to the UK population because of international differences in pathways and management, not adjusting for different in existing patient illness, or was restricted to inpatient death without fully assessing 90-day outcomes. 

This project will use national linked primary and secondary health data to provide more precise, generalisable, repeatable risk estimates appropriately adjusted for differences between patients and procedures. We will use the OpenSAFELY Trusted Research Environment to provide hospital data on procedures and investigations, readmissions, and critical care admissions from secondary care data, deaths, COVID-19 vaccination and testing data, and primary care diagnoses and prescriptions to incorporate pre-existing patient factors and the varying community levels of COVID-19 infections. This work will provide reusable tools in real-world data for patients attending hospital for care by identifying high risk patients that might need pathway improvements and low risk patients and procedures that might allow relaxation of policies to facilitate the post COVID-19 NHS recovery.


# Methods

## Study design
All identified all adult patients as the study population who underwent at least one procedure whilst registered to a general practitioner using the SystmOne database at the time of the first procedure between `r format(start.date, format="%B %d %Y")` and `r format(last.date, format="%B %d %Y")`. Patients were followed up from the admission for the operation to 90 days following discharge, and  outcomes of COVID-19 positive tests, first subsequent emergency hospital readmission, venous thromboembolism events, and all cause mortality.  

## Date sharing
Access to the underlying identifiable and potentially re-identifiable pseudonymised electronic health record data is tightly governed by various legislative and regulatory frameworks, and restricted by best practice. The data in OpenSAFELY is drawn from General Practice data across England where TPP is the data processor.

TPP developers initiate an automated process to create pseudonymised records in the core OpenSAFELY database, which are copies of key structured data tables in the identifiable records. These pseudonymised records are linked onto key external data resources that have also been pseudonymised via SHA-512 one-way hashing of NHS numbers using a shared salt. Bennett Institute for Applied Data Science developers and PIs holding contracts with NHS England have access to the OpenSAFELY pseudonymised data tables as needed to develop the OpenSAFELY tools.

These tools in turn enable researchers with OpenSAFELY data access agreements to write and execute code for data management and data analysis without direct access to the underlying raw pseudonymised patient data, and to review the outputs of this code. All code for the full data management pipeline—from raw data to completed results for this analysis—and for the OpenSAFELY platform as a whole is available for review at github.com/OpenSAFELY.

## Data source 
The Opensafely-TPP platform was used for the study and is described in detail here (www.opensafely.org). The platform allows code from the GitHub repository to be run on the pseudoanonymised primary care data of coded diagnoses, demographics and medications. Primary care records managed by the GP software provider, TPP/EMIS were linked through OpenSAFELY to inpatient hospital spell records via the NHS DIgital's Hospital Episode Statistics (HES), national coronavirus testing records via the Second Generation Surveillance System (SGSS), mortality from the Office for National Statistics death registry, and vaccination status from the National Immunisation Management System (NIMS).

## Study population 
All adult individuals were included who were older than 18 years old and registered to an OpenSAFELY-TPP primary care general practice within England whilst having an abdominal, obstetric, orthopaedic, thoracic or vascular procedure. These operative categories were defined using codelists from www.opencodelists.org and listed here https://github.com/opensafely/PostOpCovid/tree/main/codelists.

### Outcomes

We defined the following outcomes

  1. Post Operative COVID-19 infection - A positive lateral flow or PCR test recorded within the SGSS from pillar 1 or 2 testing between 0 and 30 days after the operation date. Patients with a positive test in the 7 days prior to the operation date were excluded

  2. Post Operative Venous Thromboembolism Events - A venous thromboemobolic event was defined as a diagnostic ICD 10 code within hospital records and/or diagnostic SNOMED code within primary care records, with a corresponding primary care prescription for ongoing anticoagulation in the community within 15 days before and 90 days after a VTE diagnosis and 90 days after discharge. This definition has previously been used and validated within our team within the Clinical Practice Research Datalink.

  3. Post Operative Non-COVID-19 Emergency Readmission - Any emergency hospital admission defined by an admission method beginning with '2' without a corresponding COVID-19 positive result within 90 days of discharge.

  4. Post Operative Mortality - Any death within 90 days of the operation recorded within the Office for National Statistics death registry.

### Exposures

The exposures of interest for the analysis of post operative risk of COVID-19 was operation type defined by the procedure categories, malignant or benign diagnosis, and emergency or elective admission method. 

  *	Types of Surgery - Categorised into the following major procedure groups:
	    * Abdominal procedures (including gastrointestinal, gynaecological, urological procedures)
	    *	Orthopaedic procedures
	    * Obstetric procedures
	    * Thoracic procedures
      * Vascular procedures including endovascular aneurysm repair
      
  * We also selected the following frequent procedures:
      * Colectomy
      * Cholecystectomy
	    * Hip replacement
	    * Knee replacement
	    
  *	Indication for Surgery benign/malignant - Defined using ICD-10 code for malignancy during the procedure's admission spell
  * Urgency of surgery - Defined as elective or emergency using the recorded admission method

For the post operative risk the exposure of interest was the effect of a COVID-19 positive test stratified by the timing of procedure by COVID-19 wave.

  *	Timing during the pandemic in relation to the dominant COVID-19 viral variant as defined in the Office for National Statistics Bulletins [https://www.ons.gov.uk/peoplepopulationandcommunity/healthandsocialcare/conditionsanddiseases/bulletins/coronaviruscovid19infectionsurveycharacteristicsofpeopletestingpositiveforcovid19uk/] : 
      1. Initial Wuhan variant as wave 1 - February to 1st December 2020
      2. Alpha variant as wave 2 - 1st December 2020 to 17th May 2021
      3. Delta variant as wave 3 - 17th May 2021 to 19th December 2021
      4. Omicron variant as wave 4 - 19th December 2021 to present

Additional covariates used within the analyses to adjust and stratify the results included:

  * Age - categorised into 18-49 years,50 - 69 years,70-79 years and >79 years old
  * Sex - Recorded as male or female
  * Comorbidity - Calculated as the Charlson index using primary care coding prior to the operative date and categorised into
      0. No co-morbidity in the Charlson index
      1. Single co-morbidity in the Charlson index
      2. Multiple or severe co-morbidity in the Charlson index
  *	Vaccination status - Categorised as 1,2, or 3 doses
  * Region - Defined as 
      * North East
      * North West
      * East Midlands
      * West Midlands
      * London
      * South East
      * South West
  * Socioeconomic status - Defined as quintiles of the rankings of lower super output areas of home residence by the Indices of Multiple Deprivation.
  * Recent COVID-19 infection - Defined as between 7 and 42 days prior to the operation date
  * Prior COVID-19 infection - Defined as before 42 days prior to the operation date
  * Length of stay for index admission (days) - This was included in models predicting post discharge outcomes and categorised into <= 7 days and > 7 days.

## Statistical methods
1. Using the procedure groupings we measured the 30-day risk of COVID-19 positivity following the operation date using the linked COVID-19 testing data adjusted by age, sex, region, socioeconomic status, ethnicity, timing by COVID-19 wave, malignant or benign diagnosis, emergency or elective procedure, co-morbidity and vaccination status from the linked vaccination data. Crude  30 day risks were calculated using Kaplan Meier curves stratified by the above covariates. A competing risks Cox proportional survival analysis was then be used to adjust the cumulative risk of COVID-19 infection by the competing risk of death and subsequent non COVID-19 emergency readmissions, as well as adjusting for the covariates listed above. Follow up time was censored at 30 days, end of registration at a TPP primary care practice, or when a subsequent elective procedure occured. 

2. We modelled using the procedure groupings the impact of COVID-19 positivity on overall 90-day mortality, emergency readmission, and venous thromboembolism. Crude 90 day cumulative risks were calculated using Kaplan Meier curves stratified by the covariates listed above and also length of stay in the index admission. A time varying Cox proportional hazards model was used for each outcome with COVID-19 positivity as a time varying exposure adjusted for these other patient factors. Cumulative 90 day risks were then calculated adjusted for the competing risks of mortality and non COVID-19 readmissions as appropriate. Due to small numbers of post discharge deaths, for VTE analyses mortality and readmission were combined as a common competing risk, and for readmissions we were unable to adjust for competing risks. Follow up time for readmissions began on the day following discharge. Follow up time for VTE began to be counted the day after the operation, but only post discharge follow up time was included, as inpatient VTE were coded to the same admission date as the operation which prevented a clear chronology for inpatient events. Follow up time was censored at 90 days post discharge for emergency readmissions, and 90 days post operation for VTEs. In addition follow up was censored at the end of registration at a TPP primary care practice, or when a subsequent elective procedure occured.

### Power calculation
Overall, there will be more than 10 million unique procedures within England, and the analysis will be performed on strata of groups of procedures 20,000 or larger to detect a 0.2% difference in COVID-19 risk between groups (with > 90% power and two-sided alpha 0.05). This means we will have more than 90% to detect more meaningful 0.5% difference across multiple strata adjusted for >10 multiple comparisons within each stratum. This will also allow multivariate models predicting surgical outcomes within each stratum with up to 20 predictors whilst keeping over optimism < 5%. 

Our group has previously shown that the post-operative rate for colectomy of venous thromboembolism in national English data is 0.7%. Using the R pmsampsize package for a multivariate prediction model with up to 20 predictors, an outcome prevalence anticipated to be 0.007 (0.7%), and a lower bound of the maximum possible associated R-squared value of 0.06, indicates a minimum sample size of n~ 6000 procedures to limit bias in the model from over optimism to <5%(9). Our groupings chosen in 1 above should therefore provide ample power for any outcomes with similar or greater levels of risk.

### Reporting
All patient counts were rounded to the nearest 10 patients to reduce the risk of disclosure. 

## Software and reproducibility
Data management was performed using Python [3.8], with analysis carried out using R 4.02. Code for data management and analysis, as well as codelists, are archived online [https://github.com/opensafely/PostOpCovid/]. All iterations of the pre-specified study protocol are archived with version control [https://github.com/opensafely/xxxxxx/protocol].


## Patient and Public involvement

Members of the research team have been involved with several PPI events during the Covid-19 pandemic where a wide variety of topics have been discussed and input is drawn from across these alongside the lay members of our surgical prioritisation group that has run throughout the pandemic. OpenSAFELY has developed a publicly available website https://opensafely.org/ through which they invite any patient or member of the public to make contact regarding the broader OpenSAFELY project.

## Ethical Approval and Governance

NHS England is the data controller for OpenSAFELY-TPP; TPP is the data processor; all study authors using OpenSAFELY have the approval of NHS England. This implementation of OpenSAFELY is hosted within the TPP environment which is accredited to the ISO 27001 information security standard and is NHS IG Toolkit compliant.

Patient data has been pseudonymised for analysis and linkage using industry standard cryptographic hashing techniques; all pseudonymised datasets transmitted for linkage onto OpenSAFELY are encrypted; access to the platform is via a virtual private network (VPN) connection, restricted to a small group of researchers; the researchers hold contracts with NHS England and only access the platform to initiate database queries and statistical models; all database activity is logged; only aggregate statistical outputs leave the platform environment following best practice for anonymisation of results such as statistical disclosure control for low cell counts.

The OpenSAFELY research platform adheres to the obligations of the UK General Data Protection Regulation (GDPR) and the Data Protection Act 2018. In March 2020, the Secretary of State for Health and Social Care used powers under the UK Health Service (Control of Patient Information) Regulations 2002 (COPI) to require organisations to process confidential patient information for the purposes of protecting public health, providing healthcare services to the public and monitoring and managing the COVID-19 outbreak and incidents of exposure; this sets aside the requirement for patient consent.

Taken together, these provide the legal bases to link patient datasets on the OpenSAFELY platform. GP practices, from which the primary care data are obtained, are required to share relevant health information to support the public health response to the pandemic, and have been informed of the OpenSAFELY analytics platform.

This study was approved by the HRA East of England - Essex Research Ethics Committee [protocol number 21071, REC reference 21/EE/0278].

## Acknowledgements

We are very grateful for all the support received from the TPP Technical Operations team throughout this work, and for generous assistance from the information governance and database teams at NHS England / NHSX.

# Results
## Study population
One third of GP practices in England use SystmOne, with records for approximately 44% of the English population. `r paste(n.pats)` adult patients were identified as the study population undergoing at least one procedure whilst registered to a general practitioner using the SystmOne database at the time of the first procedure between `r format(start.date, format="%B %d %Y")` and `r format(last.date, format="%B %d %Y")`. The flow chart shows the procedures identified within these patients' registration period after restricting to the first 5 procedures within each category (abdominal, cardiac, obstetric, orthopaedic,  thoracic, & vascular), and the numbers of outcomes after adjusting for censoring by competing risks.  The numbers and demographics of these patients and procedures are shown in Table 1.

```{r flowchart, fig.dim = c(6, 8),fig.align = "center",fig.cap = c("Flow chart of patients, procedures and outcomes included within censored follow up time")}
load(here::here("output","flowchart.RData"))
#knitr::include_graphics(path = here::here("output","Flowchart.pdf"))
p
```

```{r demo, results='asis', echo = F, warning=F, eval = TRUE}
demo.tab <- data.table::fread(file = here::here("output","table_demo.csv"))

 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
 knitr::kable(demo.tab, caption = "Table 1: Demographics of patients by procedure type with counts rounded to nearest 10, columns not mutually exclusive")
 )

```


## Post operative 90 day COVID-19 risk
The cumulative risk of testing positive for COVID-19 peri-opertively, from the operation to 30 days post operatively were calculated in table 2. The adjusted estimates were calculated from the Cox survival models fitted separately for COVID-19, mortality and emergency non COVID-19 admission.

```{r postopcovid, eval = T, echo=FALSE}

################################
# Post operative COVID risk model----
##################################
load(here::here("output","postopcovid_crude.RData"))
load(here::here("output","postopcovid_adjusted.RData"))

crude.covid.cov[, cov_level := paste0(Characteristic, Level) ]

covid_coef <- data.table::data.table('cov_level' = names(post.op.covid.model[[1]]$coefficients), 
                                   'Adjusted Hazard Ratio' = round(exp(post.op.covid.model[[1]]$coefficients),2),
                                   '95% CI' = paste0('(',round(exp(confint(post.op.covid.model[[1]])[,1]),2),',',round(exp(confint(post.op.covid.model[[1]])[,2]),2),')'))

readmit_coef <- data.table::data.table('cov_level' = names(post.op.covid.model[[2]]$coefficients), 
                                   'Adjusted Hazard Ratio' = round(exp(post.op.covid.model[[2]]$coefficients),2),
                                   '95% CI' = paste0('(',round(exp(confint(post.op.covid.model[[2]])[,1]),2),',',round(exp(confint(post.op.covid.model[[2]])[,2]),2),')'))

mortality_coef <- data.table::data.table('cov_level' = names(post.op.covid.model[[3]]$coefficients), 
                                   'Adjusted Hazard Ratio' = round(exp(post.op.covid.model[[3]]$coefficients),2),
                                   '95% CI' = paste0('(',round(exp(confint(post.op.covid.model[[3]])[,1]),2),',',round(exp(confint(post.op.covid.model[[3]])[,2]),2),')'))


#knitr::kable(broom::tidy(post.op.covid.model[[1]], exponentiate= T, conf.int = T),digits = 2)
procedures <- c('Abdominal','Cardiac','Obstetrics','Orthopaedic','Thoracic', 'Vascular')
comb_postop_covid <- cbind(merge(x = crude.covid.cov, y = covid_coef, by = 'cov_level', all = T , sort = F),
                           adjusted.cuminc[,1],
                           merge(x = crude.covid.cov, y = readmit_coef, by = 'cov_level', all = T , sort = F)[,.(`Adjusted Hazard Ratio`,`95% CI`)],
                           adjusted.cuminc[,3],
                           merge(x = crude.covid.cov, y = mortality_coef, by = 'cov_level', all = T , sort = F)[,.(`Adjusted Hazard Ratio`,`95% CI`)],
                           adjusted.cuminc[,c(4,2)])[-(seq(1,(length(procedures)*2)-1,2)),-1]

names(comb_postop_covid) <- c("Characteristic","Level","Number at risk",
                            "Number of post operative COVID events within 30 days",
                            "30 day COVID Cause specific Cumulative Risk adjusted for censoring",
                            "30 day COVID Cumulative Risk adjusted for competing risks of death and emergency readmission",
                            'Adjusted Hazard Ratio for 30 day COVID','95% CI',
                            "30 day COVID Cause specific Cumulative Risk adjusted for all covariates",
                            'Adjusted Hazard Ratio for censoring by 30 day readmissions before COVID infection','95% CI',
                            "30 day Readmission Cause Specific Cumulative Risk adjusted for all covariates",
                            'Adjusted Hazard Ratio for censoring by 30 day mortality before COVID infection','95% CI',
                            "30 day Mortality Cause Specific Cumulative Risk adjusted for all covariates",
                            "30 day COVID Cumulative Risk adjusted for all covariates and competing risks")

comb_postop_covid[is.na(`Adjusted Hazard Ratio for 30 day COVID`),`:=`(`Adjusted Hazard Ratio for 30 day COVID` = 1, `95% CI`= "Ref")]
comb_postop_covid[is.na(`Adjusted Hazard Ratio for censoring by 30 day readmissions before COVID infection`),`:=`(`Adjusted Hazard Ratio for censoring by 30 day readmissions before COVID infection` = 1, `95% CI`= "Ref")]
comb_postop_covid[is.na(`Adjusted Hazard Ratio for censoring by 30 day mortality before COVID infection`),`:=`(`Adjusted Hazard Ratio for censoring by 30 day mortality before COVID infection` = 1, `95% CI`= "Ref")]


 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(comb_postop_covid, 
             caption = paste0("Table 2: Cumulative incidence of 30 day post operative COVID of patients by procedure type with counts rounded to nearest 10. Adjusted predictions set for 50-70 year old female with a single morbidity with a bmi of 20, for an elective abdominal cancer operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation")
             #at their most frequent population values:\n procedure = ", procedures[which.max(dt.tv[,lapply(.SD,sum,na.rm = T), .SDcols = c(procedures)])], Reduce(lapply(which(covariates == 'age.cat'):which(covariates == 'previousCOVID'), function(i) paste0(covariates[i] ,' = ',max.category(which(covariates == covariates[i])))), f =function(x,y) paste(x,y, collapse = ", ")))
             ) %>% kableExtra::add_header_above(c(" " = 4,"Crude KM analysis" = 2, "Adjusted Cox model analysis" = 9, "Fully adjusted CIF" = 1))
)
```

#### Selected procedures

```{r postopcovid_sub, eval = T, echo=FALSE}

################################
# Post operative COVID risk model----
##################################
load(here::here("output","postopcovid_crude_sub.RData"))
load(here::here("output","postopcovid_adjusted_sub.RData"))

#knitr::kable(broom::tidy(post.op.covid.model[[1]], exponentiate= T, conf.int = T),digits = 2)


crude.covid.cov.sub[, cov_level := paste0(Characteristic, Level) ]

covid_coef_sub <- data.table::data.table('cov_level' = names(post.op.covid.model.sub[[1]]$coefficients), 
                                   'Adjusted Hazard Ratio' = round(exp(post.op.covid.model.sub[[1]]$coefficients),2),
                                   '95% CI' = paste0('(',round(exp(confint(post.op.covid.model.sub[[1]])[,1]),2),',',round(exp(confint(post.op.covid.model.sub[[1]])[,1]),2),')'))

readmission_coef_sub <- data.table::data.table('cov_level' = names(post.op.covid.model.sub[[2]]$coefficients), 
                                   'Adjusted Hazard Ratio' = round(exp(post.op.covid.model.sub[[2]]$coefficients),2),
                                   '95% CI' = paste0('(',round(exp(confint(post.op.covid.model.sub[[2]])[,1]),2),',',round(exp(confint(post.op.covid.model.sub[[2]])[,1]),2),')'))

mortality_coef_sub <- data.table::data.table('cov_level' = names(post.op.covid.model.sub[[3]]$coefficients), 
                                   'Adjusted Hazard Ratio' = round(exp(post.op.covid.model.sub[[3]]$coefficients),2),
                                   '95% CI' = paste0('(',round(exp(confint(post.op.covid.model.sub[[3]])[,1]),2),',',round(exp(confint(post.op.covid.model.sub[[3]])[,1]),2),')'))


procedures.sub <- c('Colectomy','Cholecystectomy',
                'HipReplacement','KneeReplacement')

comb_postop_covid.sub <- cbind(merge(x = crude.covid.cov.sub, y = covid_coef_sub, by = 'cov_level', all = T , sort = F),
                               adjusted.cuminc.sub[,1],
                               merge(x = crude.covid.cov.sub, y = readmission_coef_sub, by = 'cov_level', all = T , sort = F)[,.(`Adjusted Hazard Ratio`,`95% CI`)],
                               adjusted.cuminc.sub[,3],
                               merge(x = crude.covid.cov.sub, y = mortality_coef_sub, by = 'cov_level', all = T , sort = F)[,.(`Adjusted Hazard Ratio`,`95% CI`)],
                               adjusted.cuminc.sub[,c(4,2)])[-(seq(1,(length(procedures.sub)*2)-1,2)),-1]


names(comb_postop_covid.sub) <- c("Characteristic","Level","Number at risk",
                            "Number of post operative COVID events within 30 days",
                            "30 day COVID Cause specific Cumulative Risk adjusted for censoring",
                            "30 day COVID Cumulative Risk adjusted for competing risks of death and emergency readmission",
                            'Adjusted Hazard Ratio for 30 day COVID','95% CI',
                            "30 day COVID Cause specific Cumulative Risk adjusted for all covariates",
                            'Adjusted Hazard Ratio for censoring by 30 day readmissions before COVID infection','95% CI',
                            "30 day Readmission Cause Specific Cumulative Risk adjusted for all covariates",
                            'Adjusted Hazard Ratio for censoring by 30 day mortality before COVID infection','95% CI',
                            "30 day Mortality Cause Specific Cumulative Risk adjusted for all covariates",
                            "30 day COVID Cumulative Risk adjusted for all covariates and competing risks")

 
comb_postop_covid.sub[is.na(`Adjusted Hazard Ratio for 30 day COVID`),`:=`(`Adjusted Hazard Ratio for 30 day COVID` = 1, `95% CI`= "Ref")]
comb_postop_covid.sub[is.na(`Adjusted Hazard Ratio for censoring by 30 day readmissions before COVID infection`),`:=`(`Adjusted Hazard Ratio for censoring by 30 day readmissions before COVID infection` = 1, `95% CI`= "Ref")]
comb_postop_covid.sub[is.na(`Adjusted Hazard Ratio for censoring by 30 day mortality before COVID infection`),`:=`(`Adjusted Hazard Ratio for censoring by 30 day mortality before COVID infection` = 1, `95% CI`= "Ref")]


 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(comb_postop_covid.sub, 
             caption = paste0("Table 3: Cumulative incidence of 30 day post operative COVID of patients by procedure type with counts rounded to nearest 10. Adjusted predictions set for 50-70 year old female with a single morbidity with a bmi of 20, for an elective colectomy cancer operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation")
             #at their most frequent population values:\n procedure = ", procedures[which.max(dt.tv[,lapply(.SD,sum,na.rm = T), .SDcols = c(procedures)])], Reduce(lapply(which(covariates == 'age.cat'):which(covariates == 'previousCOVID'), function(i) paste0(covariates[i] ,' = ',max.category(which(covariates == covariates[i])))), f =function(x,y) paste(x,y, collapse = ", ")))
             ) %>% kableExtra::add_header_above(c(" " = 4,"Crude KM analysis" = 2, "Adjusted Cox model analysis" = 9, "Fully adjusted CIF" = 1))
)
```



### Post operative COVID-19 risk by COVID-19 waves and operation category

The  adjusted cumulative risk estimates were calculated for each COVID-19 wave stratified by operation category in table 3.

```{r postopcovid_waves}

# kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
#knitr::kable(cuminc.adjusted.waves,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 30 day post operative COVID of patients by procedure #type stratified by COVID-19 wave."), row.names = T, digits = 2)
# )
#
ggplot2::ggplot(data.table::melt(data.table::data.table(cuminc.adjusted.waves, keep.rownames = T),
                                 id.vars = 'rn',
                                 variable.name = 'Wave',
                                 value.name = '30 Day COVID Cumulative Incidence')[, `:=`(Emergency = grepl('Emergency*',rn),
                                                        Operation = gsub('Emergency|Elective', '',rn))],
                ggplot2::aes(x = Wave, 
                             y = `30 Day COVID Cumulative Incidence`, 
                             group = rn,
                             colour = Operation,
                             linetype = Emergency)) +
  ggplot2::geom_line()
```

#### Selected procedures

```{r postopcovid_waves_sub}

# kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
#knitr::kable(cuminc.adjusted.waves.sub,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 30 day post operative COVID of patients by selected procedures type stratified by COVID-19 wave."), row.names = T, digits = 2)
# )


ggplot2::ggplot(data.table::melt(data.table::data.table(cuminc.adjusted.waves.sub, keep.rownames = T),
                                 id.vars = 'rn',
                                 variable.name = 'Wave',
                                 value.name = '30 Day COVID Cumulative Incidence')[, `:=`(Emergency = grepl('Emergency*',rn),
                                                        Operation = gsub('Emergency|Elective', '',rn))],
                ggplot2::aes(x = Wave, 
                             y = `30 Day COVID Cumulative Incidence`, 
                             group = rn,
                             colour = Operation,
                             linetype = Emergency)) +
  ggplot2::geom_line()
```

### Post operative COVID-19 risk by weekly post operative period

The adjusted cumulative risk for COVID-19 were calculated for each post operative week in figure 1 stratified by emergency or elective, for a 50-70 year old female with a single morbidity with a bmi of 20, for an abdominal cancer operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation. This showed the risk peaked in the first week after operation before falling to a level baseline.

```{r postopcovid_tv}
#htmltools::includeHTML(here::here('output','postopcovidmodelsplit.html'))

weekly.post.op.risk <- data.table::fread(file = here::here("output","postopcovid_tv.csv"))

ggplot2::ggplot(weekly.post.op.risk) + #ggplot2::geom_line(ggplot2::aes(x = Days.post.discharge, y = Risk.risk)) + 
  ggplot2::geom_col(ggplot2::aes(x = factor(`Risk period`, level = c("1st week","2nd week","3rd week","4th week","5th week","6th week")), 
                                                                      y = Risk)) +
ggplot2::xlab("Days post operation") + 
  ggplot2::ylab("Cumulative risk during time period") + ggplot2::ggtitle("Post operative risk of COVID-19 over time",
                                                                         subtitle = "Adjusted for age, sex, SES, BMI, co-morbidity, vaccination,\n operation category, emergency, previous COVID-19, \n COVID_19 wave, and competing risks of death and readmission")

```   

This plot shows the daily risk of COVID-19 for a a 50-70 year old female with a single morbidity with a bmi of 20, for an abdominal cancer operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation. This showed the risk peaked in the first week after operation before falling to a level baseline.

```{r postopcovid_daily_tv, eval = F}

htmltools::includeHTML(here::here('output','postopcovidmodeldaily.html'))


daily.post.op.risk <- data.table::fread(file = here::here("output","daily_postopcovid_tv.csv"))

ggplot2::ggplot(daily.post.op.risk[`Days post op`<= 35]) +
  ggplot2::geom_line(ggplot2::aes(x = `Days post op`, y = risk)) + 
  ggplot2::geom_smooth(ggplot2::aes(x = `Days post op`, y = risk)) +
  ggplot2::ylab("Daily risk (%)") +
  ggplot2::theme_minimal() +
  ggplot2::ggtitle("Daily risk of COVID from day of operation", subtitle = "Predicted for abdominal elective cancer operation in 50-70 year old female\n BMI 20-25, 3rd IMD quintile with single morbidity\n booster vaccination and no previous COVD")
```   

#### Selected procedures

The adjusted cumulative risk for COVID-19 were calculated for each post operative week in figure 1 stratified by emergency or elective, for a 50-70 year old female with a single morbidity with a bmi of 20, for an colectomy cancer operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation. This showed the risk peaked in the first week after operation before falling to a level baseline.

```{r postopcovid_tv_sub}
htmltools::includeHTML(here::here('output','postopcovidmodelsplitsub.html'))

weekly.post.op.risk.sub <- data.table::fread(file = here::here("output","postopcovid_tv_sub.csv"))

ggplot2::ggplot(weekly.post.op.risk.sub) + #ggplot2::geom_line(ggplot2::aes(x = Days.post.discharge, y = Risk.risk)) + 
 ggplot2::geom_col(ggplot2::aes(x = factor(`Risk period`, level = c("1st week","2nd week","3rd week","4th week","5th week","6th week")), 
                                                                      y = Risk)) +
ggplot2::xlab("Risk Period post operation") + 
  ggplot2::ylab("Cumulative risk during time period") + ggplot2::ggtitle("Post operative risk of COVID-19 over time",
                                                                         subtitle = "Adjusted for age, sex, SES, BMI, co-morbidity, vaccination,\n operation category, emergency, previous COVID-19, \n COVID_19 wave, and competing risks of death and readmission")

```

```{r postopcovid_daily_sub_tv, eval = F}
htmltools::includeHTML(here::here('output','postopcovidmodeldailysub.html'))

daily.post.op.risk.sub <- data.table::fread(file = here::here("output","daily_postopcovid_tv_sub.csv"))

ggplot2::ggplot(daily.post.op.risk.sub[`Days post op`<= 35]) +
  ggplot2::geom_line(ggplot2::aes(x = `Days post op`, y = risk)) + 
  ggplot2::geom_smooth(ggplot2::aes(x = `Days post op`, y = risk)) +
  ggplot2::ylab("Daily risk (%)") +
  ggplot2::theme_minimal() +
  ggplot2::ggtitle("Daily risk of COVID from day of operation",
                   subtitle = "Predicted for  elective colectomy cancer operation in 50-70 year old female\n BMI 20-25, 3rd IMD quintile with single morbidity\n booster vaccination and no previous COVD")
```   

## COVID impact on post operative length of stay

An accelerated failure survival model was fitted to directly estimate the effect of post operative COVID-19  as a time varying covariate on post operative length of stay. Predicted length of stay was calculated stratified by the COVID infection for a 50-70 year old female  with a single morbidity with a bmi of 20, for an elective abdominal cancer operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation.

```{r postopLOS, eval = F}

load(file = here::here("output","postoplos.RData"))

#knitr::kable(broom::tidy(post.op.LOS.model, exponentiate= T, conf.int = T),digits = 2)
 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(mean.adjusted.los,col.names = paste0("Wave ",1:4),caption = paste0("Predicted mean length of stay for patients by procedure type and COVID-19 infection, stratified by COVID-19 wave."), row.names = T, digits = 2)
)
```

#### Selected procedures

```{r postopLOS_sub, eval = F}

load(file = here::here("output","postoplos_sub.RData"))

#knitr::kable(broom::tidy(data.table::fread(here::here("output","postopLOSmodel.csv")), exponentiate= T, conf.int = T),digits = 2)

 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(mean.adjusted.los.sub,col.names = paste0("Wave ",1:4),caption = paste0("Predicted mean length of stay for patients by procedure type and COVID-19 infection, stratified by COVID-19 wave."), row.names = T, digits = 2)
 )
```

## Post operative VTE risk

Adjusted Cox proportional hazards survival models were fitted to estimate the effect of post operative COVID-19  as a time varying covariate on post discharge VTE, and cumulative incidence functions calculated to adjust for competing risks of readmission and death. Predicted VTE risk was calculated stratified by the COVID infection for a 50-70 year old female  with a single morbidity with a bmi of 20, for an elective abdominal cancer operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation.

This plot shows the changing effect of post operative COVID infection on VTE riskin the initial, alpha, delta and omicron waves.

```{r postopVTE, results='asis'}
load(file = here::here("output","postopVTE.RData"))

#knitr::kable(broom::tidy(post.op.VTE.model[[1]], exponentiate= T, conf.int = T),digits = 2)
htmltools::includeHTML(here::here('output','postopVTEmodel.html'))


 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.VTE,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative VTE risk by procedure type and COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )
 
 ggplot2::ggplot(data.table::melt(data.table::data.table(cuminc.adjusted.VTE, keep.rownames = T),
                                 id.vars = 'rn',
                                 variable.name = 'Wave',
                                 value.name = '90 Day Cumulative VTE Incidence (%)')[, `:=`(COVID = grepl('^COVID*',rn),
                                                        Operation = gsub('^No COVID|^COVID', '',rn))],
                ggplot2::aes(x = Wave, 
                             y = `90 Day Cumulative VTE Incidence (%)`, 
                             group = rn,
                             colour = Operation,
                             linetype = COVID)) +
  ggplot2::geom_line()

```


This plot shows the changing effect of recent pre-operative COVID infection on VTE risk in the initial, alpha, delta and omicron waves.

```{r postopVTErecentcovid, results='asis'}
load(file = here::here("output","postopVTErecent.RData"))

#knitr::kable(broom::tidy(post.op.VTE.model.recentCOVID[[1]], exponentiate= T, conf.int = T),digits = 2)
#htmltools::includeHTML(here::here('output','postopVTEmodelrecentCOVID.html'))


 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.recent.VTE,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative VTE risk by procedure type and recent COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )
 
ggplot2::ggplot(data.table::melt(data.table::data.table(cuminc.adjusted.recent.VTE, keep.rownames = T),
                                 id.vars = 'rn',
                                 variable.name = 'Wave',
                                 value.name = '90 Day Cumulative VTE Incidence (%)')[, `:=`(`Recent COVID` = grepl('^Recent COVID*',rn),
                                                                                            Operation = gsub('^No recent COVID|^Recent COVID', '',rn))],
                ggplot2::aes(x = Wave, 
                             y = `90 Day Cumulative VTE Incidence (%)`, 
                             group = rn,
                             colour = Operation,
                             linetype = `Recent COVID`)) +
  ggplot2::geom_line()

```

This plot shows the weekly additional risk of VTE by post operative COVID infection for a 50-70 year old female with a single morbidity with a bmi of 20, for an abdominal cancer operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation. This showed the risk peaked in the first week after operation before falling to a level baseline.


```{r postopcovid_VTE_tv}
#weekly.post.op.VTE.risk <- data.table::fread(here::here("output","postopcovid_VTE_tv.csv"))

#htmltools::includeHTML(here::here('output','postopVTEmodelsplit.html'))


ggplot2::ggplot(weekly.post.op.VTE.risk) + #ggplot2::geom_line(ggplot2::aes(x = Days.post.discharge, y = Risk.risk, group = COVID, colour = COVID)) + 
 ggplot2::geom_col(ggplot2::aes(x = factor(`Risk period`, level = c("Week pre discharge","1st week","2nd week","3rd week","4th week","5th week")),
                                                                    y = Risk,
                              group = COVID,
                             colour = COVID,
                            fill = COVID), position = "dodge") +
ggplot2::xlab("Risk Period post discharge") + 
  ggplot2::ylab("Cumulative risk during time period") + ggplot2::ggtitle("Post operative risk of VTE over time stratified by COVID-19 infection",
                                                                         subtitle = "Adjusted for age, sex, SES, BMI, co-morbidity, vaccination,\n operation category, emergency, previous COVID-19, \n COVID_19 wave, and competing risks of death and readmission")

``` 

This plot shows the daily additional risk of VTE by post operative COVID infection for a 50-70 year old female with a single morbidity with a bmi of 20, for an abdominal cancer operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation. This showed the risk peaked in the first week after operation before falling to a level baseline.


```{r postopcovid_daily_VTE_tv, eval = F}
daily.post.op.VTE.risk <- data.table::fread(file = here::here("output","daily_postopcovid_VTE_tv.csv"))

htmltools::includeHTML(here::here('output','postopVTEmodeldaily.html'))


ggplot2::ggplot(daily.post.op.VTE.risk[`Days post discharge`<= 90]) +
  ggplot2::geom_line(ggplot2::aes(x = `Days post discharge`, y = Risk, colour = COVID)) + 
  ggplot2::geom_smooth(ggplot2::aes(x = `Days post discharge`, y = Risk, colour = COVID)) + 
  ggplot2::ylab("Daily risk (%)") +
  ggplot2::theme_minimal() +
  ggplot2::ggtitle("Daily risk of VTE from day of discharge",
   subtitle = "Predicted for abdominal elective cancer operation in 50-70 year old female\n BMI 20-25, 3rd IMD quintile with single morbidity\n booster vaccination and no previous COVD")
```   

#### Selected procedures 

```{r postopVTE_sub, results='asis', eval = F}
load(file = here::here("output","postopVTE_sub.RData"))

#knitr::kable(broom::tidy(post.op.VTE.model[[1]], exponentiate= T, conf.int = T),digits = 2)
htmltools::includeHTML(here::here('output','postopVTEmodelsplitsub.html'))


 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.VTE.sub,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative VTE risk by procedure type and COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )

```

This plot shows the changing effect of post operative COVID infection on VTE risk in the initial, alpha, delta and omicron waves for a 50-70 year old female with a single morbidity with a bmi of 20, for a cancer colectomy operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation..

```{r postopVTE_sub_plot}
 
 ggplot2::ggplot(data.table::melt(data.table::data.table(cuminc.adjusted.VTE.sub, keep.rownames = T),
                                 id.vars = 'rn',
                                 variable.name = 'Wave',
                                 value.name = '90 Day Cumulative VTE Incidence')[, `:=`(COVID = grepl('^COVID*',rn),
                                                        Operation = gsub('^No COVID|^COVID', '',rn))],
                ggplot2::aes(x = Wave, 
                             y = `90 Day Cumulative VTE Incidence`, 
                             group = rn,
                             colour = Operation,
                             linetype = COVID)) +
  ggplot2::geom_line()
 
```

This shows the changing effect of recent pre operative COVID infection on VTE risk in the initial, alpha, delta and omicron waves for a 50-70 year old female with a single morbidity with a bmi of 20, for a cancer colectomy operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation..


```{r postopVTErecentcovid_sub, results='asis', eval = F}
load(file = here::here("output","postopVTErecent_sub.RData"))

#knitr::kable(broom::tidy(post.op.VTE.model.recentCOVID.sub[[1]], exponentiate= T, conf.int = T),digits = 2)
 htmltools::includeHTML(here::here('output','postopVTEmodelrecentCOVIDsub.html'))


 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.VTE.recent.sub,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative VTE risk by procedure type and recent COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )
 
```

 This plot shows the changing effect of recent pre operative COVID infection on VTE risk in the initial, alpha, delta and omicron waves for a 50-70 year old female with a single morbidity with a bmi of 20, for a cancer colectomy operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation..


```{r postopVTErecentcovid_sub_plot}
ggplot2::ggplot(data.table::melt(data.table::data.table(cuminc.adjusted.VTE.recent.sub, keep.rownames = T),
                                 id.vars = 'rn',
                                 variable.name = 'Wave',
                                 value.name = '90 Day Cumulative VTE Incidence (%)')[, `:=`(`Recent COVID` = grepl('^Recent COVID*',rn),
                                                                                            Operation = gsub('^No recent COVID|^Recent COVID', '',rn))],
                ggplot2::aes(x = Wave, 
                             y = `90 Day Cumulative VTE Incidence (%)`, 
                             group = rn,
                             colour = Operation,
                             linetype = `Recent COVID`)) +
  ggplot2::geom_line()

```

 This plot shows the effect of post operative COVID infection on each week's additional VTE risk in first month after discharge for a 50-70 year old female with a single morbidity with a bmi of 20, for a cancer colectomy operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation..


```{r postopcovid_VTE_tv_sub}
weekly.post.op.VTE.risk.sub <- data.table::fread(here::here("output","postopcovid_VTE_tv_sub.csv"))
 
htmltools::includeHTML(here::here('output','postopVTEmodelsplitsub.html'))

ggplot2::ggplot(weekly.post.op.VTE.risk.sub) +
 ggplot2::geom_col(ggplot2::aes(x = factor(`Risk period`, level = c("Week pre discharge","1st week","2nd week","3rd week","4th week","5th week")),
                                                                    y = Risk,
                              group = COVID,
                             colour = COVID,
                            fill = COVID), position = "dodge") +
ggplot2::xlab("Risk Period post discharge") + 
  ggplot2::ylab("Cumulative risk during time period") + 
  ggplot2::ggtitle("Post operative risk of VTE over time stratified by COVID-19 infection",
                                                                         subtitle = "Adjusted for age, sex, SES, BMI, co-morbidity, vaccination,\n operation category, emergency, previous COVID-19, \n COVID_19 wave, and competing risks of death and readmission")

``` 

 This plot shows the effect of post operative COVID infection on each day's additional VTE risk in first month after discharge for a 50-70 year old female with a single morbidity with a bmi of 20, for a cancer colectomy operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation..


```{r postopcovid_daily_sub_VTE_tv, eval = F}
daily.post.op.VTE.risk.sub <- data.table::fread(file = here::here("output","daily_postopcovid_VTE_tv_sub.csv"))

htmltools::includeHTML(here::here('output','postopVTEmodeldailysub.html'))

ggplot2::ggplot(daily.post.op.VTE.risk.sub[`Days post discharge`<= 35]) +
  ggplot2::geom_line(ggplot2::aes(x = `Days post discharge`, y = Risk, colour = COVID)) + 
  ggplot2::geom_smooth(ggplot2::aes(x = `Days post discharge`, y = Risk, colour = COVID)) + 
  ggplot2::ylab("Daily risk (%)") +
  ggplot2::theme_minimal() +
  ggplot2::ggtitle("Daily risk of VTE from day of discharge",
   subtitle = "Predicted for elective colectomy cancer operation in 50-70 year old female\n BMI 20-25, 3rd IMD quintile with single morbidity\n booster vaccination and no previous COVD")
```   

## COVID impact on post operative Mortality

Adjusted Cox proportional hazards survival models were fitted to estimate the effect of post operative COVID-19 as a time varying covariate on mortality, and cumulative incidence functions calculated to adjust for competing risks of readmission. Predicted mortality was calculated stratified by the COVID infection for a 50-70 year old female  with a single morbidity with a bmi of 20, for an elective abdominal cancer operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation.

```{r postopmortality}
load(file = here::here("output","postopmortality.RData"))

#knitr::kable(broom::tidy(post.op.died.model[[1]], exponentiate= T, conf.int = T),digits = 2)
htmltools::includeHTML(here::here('output','postopdiedmodel.html'))

 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.mortality,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative mortality risk by procedure type and COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )
 
 
 
 ggplot2::ggplot(data.table::melt(data.table::data.table(cuminc.adjusted.mortality, keep.rownames = T),
                                 id.vars = 'rn',
                                 variable.name = 'Wave',
                                 value.name = '90 Day Cumulative Mortality Risk')[, `:=`(COVID = grepl('^COVID*',rn),
                                                        Operation = gsub('^No COVID|^COVID', '',rn))],
                ggplot2::aes(x = Wave, 
                             y = `90 Day Cumulative Mortality Risk`, 
                             group = rn,
                             colour = Operation,
                             linetype = COVID)) +
  ggplot2::geom_line()
```

#### Selected procedures


```{r postopmortality_sub}
load(file = here::here("output","postopmortality_sub.RData"))

#knitr::kable(broom::tidy(post.op.died.model[[1]], exponentiate= T, conf.int = T),digits = 2)
htmltools::includeHTML(here::here('output','postopdiedmodelsub.html'))

 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.mortality.sub,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative mortality risk by procedure type and COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )
 
  
 ggplot2::ggplot(data.table::melt(data.table::data.table(cuminc.adjusted.mortality.sub, keep.rownames = T),
                                 id.vars = 'rn',
                                 variable.name = 'Wave',
                                 value.name = '90 Day Cumulative Mortality Risk')[, `:=`(COVID = grepl('^COVID*',rn),
                                                        Operation = gsub('^No COVID|^COVID', '',rn))],
                ggplot2::aes(x = Wave, 
                             y = `90 Day Cumulative Mortality Risk`, 
                             group = rn,
                             colour = Operation,
                             linetype = COVID)) +
  ggplot2::geom_line()
```

## COVID impact on Emergency Readmission

Adjusted Cox proportional hazards survival models were fitted to estimate the effect of post operative COVID-19  as a time varying covariate on post discharge emergency readmission, and cumulative incidence functions calculated to adjust for competing risks of death. Predicted emergency readmission was calculated stratified by the COVID infection for a 50-70 year old female  with a single morbidity with a bmi of 20, for an elective abdominal cancer operation, without previous COVID-19, with a booster vaccination, from the East Midlands in an area ranked in the 3rd quintile for deprivation.

```{r postopreadmit, eval = F}
load(file = here::here("output","postopreadmit.RData"))
htmltools::includeHTML(here::here('output','postopreadmitmodel.html'))

 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.readmit,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative emergency non covid readmission risk by procedure type and COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )
 
  
 ggplot2::ggplot(data.table::melt(data.table::data.table(cuminc.adjusted.readmit, keep.rownames = T),
                                 id.vars = 'rn',
                                 variable.name = 'Wave',
                                 value.name = '90 Day Cumulative Readmission Incidence')[, `:=`(COVID = grepl('^COVID*',rn),
                                                        Operation = gsub('^No COVID|^COVID', '',rn))],
                ggplot2::aes(x = Wave, 
                             y = `90 Day Cumulative Readmission Incidence`, 
                             group = rn,
                             colour = Operation,
                             linetype = COVID)) +
  ggplot2::geom_line()
```

#### Selected procedures


```{r postopreadmit_sub, eval = F}
load(file = here::here("output","postopreadmit_sub.RData"))
htmltools::includeHTML(here::here('output','postopreadmitmodelsub.html'))

 kableExtra::kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"),
knitr::kable(cuminc.adjusted.readmit.sub,col.names = paste0("Wave ",1:4),caption = paste0("Cumulative incidence of 90 day post operative emergency non covid readmission risk by selected procedure type and COVID-19 infection, and stratified by COVID-19 wave."), row.names = T, digits = 4)
 )
 
   
 ggplot2::ggplot(data.table::melt(data.table::data.table(cuminc.adjusted.readmit.sub, keep.rownames = T),
                                 id.vars = 'rn',
                                 variable.name = 'Wave',
                                 value.name = '90 Day Cumulative Readmission Incidence')[, `:=`(COVID = grepl('^COVID*',rn),
                                                        Operation = gsub('^No COVID|^COVID', '',rn))],
                ggplot2::aes(x = Wave, 
                             y = `90 Day Cumulative Readmission Incidence`, 
                             group = rn,
                             colour = Operation,
                             linetype = COVID)) +
  ggplot2::geom_line()
```